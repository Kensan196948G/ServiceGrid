name: Claude API Direct Loop

on:
  workflow_dispatch:
  push:
    branches: [ main, master ]

jobs:
  claude-api-loop:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“‚ ãƒªãƒã‚¸ãƒˆãƒªãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      uses: actions/checkout@v4
      
    - name: ğŸ¤– Claude API ç›´æ¥å‘¼ã³å‡ºã—ãƒ«ãƒ¼ãƒ—
      env:
        ANTHROPIC_API_KEY: ${{ secrets.CLAUDE_API_KEY }}
        CLAUDE_MAX_ITERATIONS: 5
        TZ: Asia/Tokyo
        SPEC_FILE: "ITSMæº–æ‹ ITé‹ç”¨ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ  è©³ç´°ä»•æ§˜æ›¸ã€æœ€æ–°ç‰ˆ2025å¹´6æœˆ7æ—¥ã€‘.txt"
      run: |
        echo "ğŸš€ Claude APIç›´æ¥å‘¼ã³å‡ºã—è‡ªå‹•é–‹ç™ºãƒ«ãƒ¼ãƒ—é–‹å§‹"
        
        # ä»•æ§˜æ›¸ãƒ•ã‚¡ã‚¤ãƒ«ç¢ºèªãƒ»èª­ã¿è¾¼ã¿
        if [ -f "$SPEC_FILE" ]; then
          echo "âœ… ä»•æ§˜æ›¸ãƒ•ã‚¡ã‚¤ãƒ«ç¢ºèª: $SPEC_FILE"
          SPEC_CONTENT=$(cat "$SPEC_FILE" | head -c 8000)  # APIåˆ¶é™å¯¾ç­–
        else
          echo "âš ï¸ ä»•æ§˜æ›¸ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
          SPEC_CONTENT="ITSMæº–æ‹ ITé‹ç”¨ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã®é–‹ç™ºã‚’è¡Œã£ã¦ãã ã•ã„ã€‚"
        fi
        
        ITER=1
        SUCCESS_COUNT=0
        
        while [ $ITER -le $CLAUDE_MAX_ITERATIONS ]; do
          echo "======================================"
          echo "ğŸŒ€ Claude APIå‘¼ã³å‡ºã— $ITER å›ç›®"
          echo "======================================"
          
          # APIå‘¼ã³å‡ºã—
          RESPONSE=$(curl -s -w "%{http_code}" -X POST https://api.anthropic.com/v1/messages \
            -H "Content-Type: application/json" \
            -H "x-api-key: $ANTHROPIC_API_KEY" \
            -H "anthropic-version: 2023-06-01" \
            -d '{
              "model": "claude-3-sonnet-20240229",
              "max_tokens": 4000,
              "messages": [
                {
                  "role": "user", 
                  "content": "'"ç¬¬${ITER}å›ç›®ã®é–‹ç™ºã‚µã‚¤ã‚¯ãƒ«ã§ã™ã€‚ä»¥ä¸‹ã®ä»•æ§˜ã«åŸºã¥ã„ã¦ITSMæº–æ‹ ã®ITé‹ç”¨ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã‚’é–‹ç™ºã—ã¦ãã ã•ã„ï¼š\n\n${SPEC_CONTENT}\n\nå‰å›ã¾ã§ã®é–‹ç™ºçŠ¶æ³ã‚’è€ƒæ…®ã—ã€ç¶™ç¶šçš„ãªæ”¹å–„ã‚’è¡Œã£ã¦ãã ã•ã„ã€‚å®Ÿéš›ã®ã‚³ãƒ¼ãƒ‰ã€è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã€ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚"'"
                }
              ]
            }')
          
          HTTP_CODE="${RESPONSE: -3}"
          RESPONSE_BODY="${RESPONSE%???}"
          
          if [ "$HTTP_CODE" = "200" ]; then
            echo "âœ… Claude APIå‘¼ã³å‡ºã— $ITER æˆåŠŸ"
            SUCCESS_COUNT=$((SUCCESS_COUNT+1))
            
            # ãƒ¬ã‚¹ãƒãƒ³ã‚¹å‡¦ç†
            echo "ğŸ“ Claudeå¿œç­”ï¼ˆæŠœç²‹ï¼‰:"
            echo "$RESPONSE_BODY" | jq -r '.content[0].text' | head -20
            
            # ãƒ•ã‚¡ã‚¤ãƒ«ç”Ÿæˆï¼ˆä¾‹ï¼‰
            OUTPUT_FILE="claude_output_${ITER}.md"
            echo "$RESPONSE_BODY" | jq -r '.content[0].text' > "$OUTPUT_FILE"
            echo "ğŸ’¾ å‡ºåŠ›ãƒ•ã‚¡ã‚¤ãƒ«ç”Ÿæˆ: $OUTPUT_FILE"
            
          else
            echo "âš ï¸ Claude API ã‚¨ãƒ©ãƒ¼ (HTTP $HTTP_CODE): ãƒ«ãƒ¼ãƒ— $ITER å¤±æ•—"
            echo "ã‚¨ãƒ©ãƒ¼è©³ç´°: $RESPONSE_BODY"
          fi
          
          ITER=$((ITER+1))
          
          # APIåˆ¶é™å¯¾ç­–ã®å¾…æ©Ÿ
          if [ $ITER -le $CLAUDE_MAX_ITERATIONS ]; then
            echo "â³ APIåˆ¶é™å¯¾ç­–ã§10ç§’å¾…æ©Ÿ..."
            sleep 10
          fi
        done
        
        echo "======================================"
        echo "ğŸ‰ Claude APIè‡ªå‹•é–‹ç™ºãƒ«ãƒ¼ãƒ—å®Œäº†"
        echo "ğŸ“ˆ æˆåŠŸå›æ•°: $SUCCESS_COUNT / $CLAUDE_MAX_ITERATIONS"
        echo "======================================"
        
        # ç”Ÿæˆãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§
        echo "ğŸ“ ç”Ÿæˆã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«:"
        ls -la claude_output_*.md 2>/dev/null || echo "ç”Ÿæˆãƒ•ã‚¡ã‚¤ãƒ«ãªã—"
        
    - name: ğŸ“‹ å®Ÿè¡Œçµæœã‚¢ãƒ¼ã‚«ã‚¤ãƒ–
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: claude-api-results
        path: |
          claude_output_*.md
          **/*.py
          **/*.js
          **/*.md
        retention-days: 7
