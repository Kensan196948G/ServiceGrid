name: Claude Auto Loop

on:
  workflow_dispatch:
    inputs:
      instructions:
        description: 'Claudeã¸ã®æ—¥æœ¬èªæŒ‡ç¤º'
        required: false
        default: 'åŒ…æ‹¬çš„ãªã‚·ã‚¹ãƒ†ãƒ è¨ºæ–­ã¨è‡ªå‹•æ”¹å–„ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„'
      mode:
        description: 'å®Ÿè¡Œãƒ¢ãƒ¼ãƒ‰'
        required: true
        default: 'full-auto'
        type: choice
        options:
          - full-auto
          - safe-mode
          - aggressive
  schedule:
    - cron: '0 */6 * * *'

env:
  CLAUDE_MAX_ITERATIONS: "5"
  TZ: 'Asia/Tokyo'

jobs:
  claude-auto-loop:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸš€ Repository Checkout
        uses: actions/checkout@v4

      - name: ğŸ”§ Install Claude Code CLI
        run: |
          npm install -g @anthropic-ai/claude-code

      - name: ğŸ“ Find Latest Spec File
        id: specfile
        run: |
          FILE=$(ls -1 *æœ€æ–°ç‰ˆ*.txt 2>/dev/null | head -n 1)
          if [ -z "$FILE" ]; then
            FILE=$(ls -1 "ITSMæº–æ‹ ITé‹ç”¨ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ  è©³ç´°ä»•æ§˜æ›¸.txt" 2>/dev/null || true)
          fi
          if [ -z "$FILE" ]; then
            echo "âš ï¸ ä»•æ§˜æ›¸ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆ.txtï¼‰ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
            exit 1
          fi
          echo "SPEC_FILE=$FILE" >> $GITHUB_ENV
          echo "ä½¿ç”¨ã™ã‚‹ä»•æ§˜æ›¸ãƒ•ã‚¡ã‚¤ãƒ«: $FILE"

      - name: ğŸ¤– Claude Auto Loop Execution
        env:
          CLAUDE_API_KEY: ${{ secrets.CLAUDE_API_KEY }}
        run: |
          echo "ğŸš€ Claudeè‡ªå‹•é–‹ç™ºãƒ»ä¿®å¾©ãƒ«ãƒ¼ãƒ—é–‹å§‹"
          ITER=1
          while [ $ITER -le $CLAUDE_MAX_ITERATIONS ]; do
            echo "----------------------"
            echo "ğŸŒ€ ãƒ«ãƒ¼ãƒ— $ITER å›ç›®"
            echo "----------------------"
            claude-code \
              --file "$SPEC_FILE" \
              --instructions "${{ github.event.inputs.instructions || 'åŒ…æ‹¬çš„ãªã‚·ã‚¹ãƒ†ãƒ è¨ºæ–­ã¨è‡ªå‹•æ”¹å–„ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„' }}" \
              --lang "ja" \
              --auto-approve \
              --no-prompts \
              --silent-mode \
              --mode "${{ github.event.inputs.mode || 'full-auto' }}"
            STATUS=$?
            if [ $STATUS -eq 0 ]; then
              echo "âœ… Claudeé–‹ç™ºãƒ«ãƒ¼ãƒ— $ITER å®Œäº†"
            else
              echo "âš ï¸ Claudeã‚¨ãƒ©ãƒ¼: ãƒ«ãƒ¼ãƒ— $ITER å¤±æ•—ã€æ¬¡ã«é€²ã¿ã¾ã™"
            fi
            ITER=$((ITER+1))
          done
          echo "ğŸ‰ Claudeè‡ªå‹•é–‹ç™ºãƒ«ãƒ¼ãƒ—å®Œäº†"

      - name: ğŸ’¾ Commit Changes
        if: success()
        run: |
          git config --local user.email "kensan1969@gmail.com"
          git config --local user.name "Kensan196948G"
          git add -A
          git diff --staged --quiet || git commit -m "ğŸ¤– Claude Auto Development: $(date '+%Y-%m-%d %H:%M:%S JST')"
          git push

      - name: ğŸ“Š Report Results
        if: always()
        run: |
          echo "å®Ÿè¡Œå®Œäº†æ™‚åˆ»: $(date '+%Y-%m-%d %H:%M:%S JST')"
          echo "GitHub Actionså®Ÿè¡Œãƒ­ã‚°ã‚’ç¢ºèªã—ã¦ãã ã•ã„"
