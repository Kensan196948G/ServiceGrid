name: Claude Auto Loop

on:
  workflow_dispatch:
    inputs:
      instructions:
        description: 'Claudeへの日本語指示'
        required: false
        default: '包括的なシステム診断と自動改善を実行してください'
      mode:
        description: '実行モード'
        required: true
        default: 'full-auto'
        type: choice
        options:
          - full-auto
          - safe-mode
          - aggressive
  schedule:
    - cron: '0 */6 * * *'

env:
  CLAUDE_MAX_ITERATIONS: "5"
  TZ: 'Asia/Tokyo'

jobs:
  claude-auto-loop:
    runs-on: ubuntu-latest

    steps:
      - name: 🚀 Repository Checkout
        uses: actions/checkout@v4

      - name: 🔧 Install Claude Code CLI
        run: |
          npm install -g @anthropic-ai/claude-code

      - name: 📝 Find Latest Spec File
        id: specfile
        run: |
          FILE=$(ls -1 *最新版*.txt 2>/dev/null | head -n 1)
          if [ -z "$FILE" ]; then
            FILE=$(ls -1 "ITSM準拠IT運用システムプラットフォーム 詳細仕様書.txt" 2>/dev/null || true)
          fi
          if [ -z "$FILE" ]; then
            echo "⚠️ 仕様書ファイル（.txt）が見つかりません"
            exit 1
          fi
          echo "SPEC_FILE=$FILE" >> $GITHUB_ENV
          echo "使用する仕様書ファイル: $FILE"

      - name: 🤖 Claude Auto Loop Execution
        env:
          CLAUDE_API_KEY: ${{ secrets.CLAUDE_API_KEY }}
        run: |
          echo "🚀 Claude自動開発・修復ループ開始"
          ITER=1
          while [ $ITER -le $CLAUDE_MAX_ITERATIONS ]; do
            echo "----------------------"
            echo "🌀 ループ $ITER 回目"
            echo "----------------------"
            claude-code \
              --file "$SPEC_FILE" \
              --instructions "${{ github.event.inputs.instructions || '包括的なシステム診断と自動改善を実行してください' }}" \
              --lang "ja" \
              --auto-approve \
              --no-prompts \
              --silent-mode \
              --mode "${{ github.event.inputs.mode || 'full-auto' }}"
            STATUS=$?
            if [ $STATUS -eq 0 ]; then
              echo "✅ Claude開発ループ $ITER 完了"
            else
              echo "⚠️ Claudeエラー: ループ $ITER 失敗、次に進みます"
            fi
            ITER=$((ITER+1))
          done
          echo "🎉 Claude自動開発ループ完了"

      - name: 💾 Commit Changes
        if: success()
        run: |
          git config --local user.email "kensan1969@gmail.com"
          git config --local user.name "Kensan196948G"
          git add -A
          git diff --staged --quiet || git commit -m "🤖 Claude Auto Development: $(date '+%Y-%m-%d %H:%M:%S JST')"
          git push

      - name: 📊 Report Results
        if: always()
        run: |
          echo "実行完了時刻: $(date '+%Y-%m-%d %H:%M:%S JST')"
          echo "GitHub Actions実行ログを確認してください"
