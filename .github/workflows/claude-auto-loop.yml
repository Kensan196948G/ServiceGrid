name: Claude Complete Auto Development

on:
  issue_comment:
    types: [created]
  workflow_dispatch:
    inputs:
      instructions:
        description: 'Claudeã¸ã®æ—¥æœ¬èªæŒ‡ç¤º'
        required: false
        default: 'åŒ…æ‹¬çš„ãªã‚·ã‚¹ãƒ†ãƒ è¨ºæ–­ã¨è‡ªå‹•æ”¹å–„ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„'
      mode:
        description: 'å®Ÿè¡Œãƒ¢ãƒ¼ãƒ‰'
        required: true
        default: 'full-auto'
        type: choice
        options:
          - full-auto
          - safe-mode
          - aggressive
  schedule:
    - cron: '0 */6 * * *'  # 6æ™‚é–“ã”ã¨ã«å®Ÿè¡Œï¼ˆä¿®æ­£: ä½™åˆ†ãª*ã‚’å‰Šé™¤ï¼‰

env:
  CLAUDE_MAX_ITERATIONS: "5"
  TZ: 'Asia/Tokyo'

jobs:
  claude-complete-automation:
    if: |
      github.event_name == 'workflow_dispatch' ||
      github.event_name == 'schedule' ||
      (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@claude'))
    runs-on: ubuntu-latest
    timeout-minutes: 60
    permissions:
      contents: write
      issues: write
      pull-requests: write
      
    steps:
      - name: ğŸš€ Repository Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
          
      - name: ğŸ”§ Environment Setup
        run: |
          echo "Claudeå…¬å¼CLIç’°å¢ƒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ä¸­..."
          sudo apt-get update && sudo apt-get install -y jq curl git bc
          
          # Node.js ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
          curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
          sudo apt-get install -y nodejs
          
          # Claude Code CLI ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
          npm install -g @anthropic-ai/claude-code
          
          # ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ç¢ºèª
          echo "Node.js version: $(node --version)"
          echo "npm version: $(npm --version)"
          
          # Claude Code ã®ç¢ºèª
          if command -v claude-code &> /dev/null; then
            echo "âœ… Claude Code CLI ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æˆåŠŸ"
            claude-code --version || echo "ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç¢ºèªä¸­..."
          else
            echo "âŒ Claude Code CLI ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«å¤±æ•—"
            exit 1
          fi
          
      - name: ğŸ“ Find Latest Spec File
        id: specfile
        run: |
          echo "ğŸ” ä»•æ§˜æ›¸ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ¤œç´¢ä¸­..."
          
          # å„ªå…ˆé †ä½ä»˜ãã§ãƒ•ã‚¡ã‚¤ãƒ«æ¤œç´¢
          SPEC_FILE=""
          
          # 1. æœ€æ–°ç‰ˆä»˜ããƒ•ã‚¡ã‚¤ãƒ«
          if [ -z "$SPEC_FILE" ]; then
            SPEC_FILE=$(find . -name "*æœ€æ–°ç‰ˆ*.txt" -type f | head -n 1)
          fi
          
          # 2. ITSMé–¢é€£ãƒ•ã‚¡ã‚¤ãƒ«
          if [ -z "$SPEC_FILE" ]; then
            SPEC_FILE=$(find . -name "*ITSM*ä»•æ§˜æ›¸*.txt" -type f | head -n 1)
          fi
          
          # 3. ä¸€èˆ¬çš„ãªä»•æ§˜æ›¸ãƒ•ã‚¡ã‚¤ãƒ«
          if [ -z "$SPEC_FILE" ]; then
            SPEC_FILE=$(find . -name "*ä»•æ§˜æ›¸*.txt" -type f | head -n 1)
          fi
          
          # 4. ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆ
          if [ -z "$SPEC_FILE" ]; then
            SPEC_FILE="default_spec.txt"
            echo "ITSMæº–æ‹ ITé‹ç”¨ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ é–‹ç™ºä»•æ§˜æ›¸" > "$SPEC_FILE"
            echo "åŒ…æ‹¬çš„ãªITé‹ç”¨ã‚·ã‚¹ãƒ†ãƒ ã®è¨­è¨ˆãƒ»é–‹ç™ºãƒ»å®Ÿè£…ã‚’è¡Œã£ã¦ãã ã•ã„ã€‚" >> "$SPEC_FILE"
            echo "âš ï¸ ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆä»•æ§˜æ›¸ã‚’ä½œæˆã—ã¾ã—ãŸ: $SPEC_FILE"
          fi
          
          echo "SPEC_FILE=$SPEC_FILE" >> $GITHUB_ENV
          echo "âœ… ä½¿ç”¨ã™ã‚‹ä»•æ§˜æ›¸ãƒ•ã‚¡ã‚¤ãƒ«: $SPEC_FILE"
          echo "ğŸ“„ ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚º: $(wc -c < "$SPEC_FILE") bytes"
          
      - name: ğŸ—ï¸ Parse Input Parameters
        id: parse_params
        run: |
          echo "ğŸ”§ å®Ÿè¡Œãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’è¨­å®šä¸­..."
          
          # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤è¨­å®š
          MODE="full-auto"
          INSTRUCTIONS="åŒ…æ‹¬çš„ãªã‚·ã‚¹ãƒ†ãƒ è¨ºæ–­ã¨è‡ªå‹•æ”¹å–„ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„"
          
          # workflow_dispatch ã‹ã‚‰ã®å…¥åŠ›å€¤
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            if [ -n "${{ github.event.inputs.mode }}" ]; then
              MODE="${{ github.event.inputs.mode }}"
            fi
            if [ -n "${{ github.event.inputs.instructions }}" ]; then
              INSTRUCTIONS="${{ github.event.inputs.instructions }}"
            fi
          fi
          
          # issue_comment ã‹ã‚‰ã®è§£æ
          if [ "${{ github.event_name }}" = "issue_comment" ]; then
            COMMENT="${{ github.event.comment.body }}"
            
            # ãƒ¢ãƒ¼ãƒ‰è§£æ
            if echo "$COMMENT" | grep -q -- '--mode'; then
              EXTRACTED_MODE=$(echo "$COMMENT" | sed -n 's/.*--mode[ =]\([^ ]*\).*/\1/p')
              if [ -n "$EXTRACTED_MODE" ]; then
                MODE="$EXTRACTED_MODE"
              fi
            fi
            
            # æŒ‡ç¤ºè§£æ
            if echo "$COMMENT" | grep -q -- '--instructions'; then
              EXTRACTED_INSTRUCTIONS=$(echo "$COMMENT" | sed -n 's/.*--instructions[ =]"\([^"]*\)".*/\1/p')
              if [ -n "$EXTRACTED_INSTRUCTIONS" ]; then
                INSTRUCTIONS="$EXTRACTED_INSTRUCTIONS"
              fi
            fi
          fi
          
          # ç’°å¢ƒå¤‰æ•°ã«è¨­å®š
          echo "MODE=$MODE" >> $GITHUB_ENV
          echo "INSTRUCTIONS=$INSTRUCTIONS" >> $GITHUB_ENV
          
          echo "ğŸ“‹ å®Ÿè¡Œè¨­å®š:"
          echo "  - ãƒ¢ãƒ¼ãƒ‰: $MODE"
          echo "  - æŒ‡ç¤º: $INSTRUCTIONS"
          
      - name: ğŸ¤– Claude Auto Loop Execution
        env:
          ANTHROPIC_API_KEY: ${{ secrets.CLAUDE_API_KEY }}
          CLAUDE_API_KEY: ${{ secrets.CLAUDE_API_KEY }}  # ä¸¡æ–¹ã®åå‰ã§è¨­å®š
        run: |
          echo "ğŸš€ Claudeè‡ªå‹•é–‹ç™ºãƒ»ä¿®å¾©ãƒ«ãƒ¼ãƒ—é–‹å§‹"
          
          # API ã‚­ãƒ¼ç¢ºèª
          if [ -z "$ANTHROPIC_API_KEY" ] && [ -z "$CLAUDE_API_KEY" ]; then
            echo "âŒ APIã‚­ãƒ¼ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“"
            echo "GitHub Secrets ã« CLAUDE_API_KEY ã¾ãŸã¯ ANTHROPIC_API_KEY ã‚’è¨­å®šã—ã¦ãã ã•ã„"
            exit 1
          fi
          
          # ãƒ•ã‚¡ã‚¤ãƒ«å­˜åœ¨ç¢ºèª
          if [ ! -f "$SPEC_FILE" ]; then
            echo "âŒ ä»•æ§˜æ›¸ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: $SPEC_FILE"
            exit 1
          fi
          
          echo "ğŸ“‹ å®Ÿè¡Œç’°å¢ƒ:"
          echo "  - ä»•æ§˜æ›¸: $SPEC_FILE"
          echo "  - ãƒ¢ãƒ¼ãƒ‰: $MODE"
          echo "  - æœ€å¤§åå¾©: $CLAUDE_MAX_ITERATIONS"
          echo "  - æŒ‡ç¤º: $INSTRUCTIONS"
          
          # ãƒ¡ã‚¤ãƒ³ãƒ«ãƒ¼ãƒ—
          ITER=1
          SUCCESS_COUNT=0
          FAILED_COUNT=0
          
          while [ $ITER -le $CLAUDE_MAX_ITERATIONS ]; do
            echo "======================================"
            echo "ğŸŒ€ Claudeé–‹ç™ºãƒ«ãƒ¼ãƒ— $ITER å›ç›®"
            echo "======================================"
            
            # Claudeå®Ÿè¡Œï¼ˆå®Ÿéš›ã®APIã«åˆã‚ã›ã¦èª¿æ•´ï¼‰
            if command -v claude-code &> /dev/null; then
              # å…¬å¼CLIã‚’ä½¿ç”¨
              claude-code \
                --file "$SPEC_FILE" \
                --message "$INSTRUCTIONS (ãƒ¢ãƒ¼ãƒ‰: $MODE, ç¬¬${ITER}å›ç›®ã®å®Ÿè¡Œ)" \
                --auto-approve 2>&1 || {
                  echo "âš ï¸ claude-codeã‚³ãƒãƒ³ãƒ‰ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ"
                  STATUS=1
                }
              STATUS=$?
            else
              # APIãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆå‘¼ã³å‡ºã—ï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰
              echo "ğŸ”„ APIç›´æ¥å‘¼ã³å‡ºã—ãƒ¢ãƒ¼ãƒ‰ã§å®Ÿè¡Œä¸­..."
              
              # ä»•æ§˜æ›¸å†…å®¹èª­ã¿è¾¼ã¿
              SPEC_CONTENT=$(head -c 4000 "$SPEC_FILE")
              
              RESPONSE=$(curl -s -w "%{http_code}" -X POST https://api.anthropic.com/v1/messages \
                -H "Content-Type: application/json" \
                -H "x-api-key: ${ANTHROPIC_API_KEY:-$CLAUDE_API_KEY}" \
                -H "anthropic-version: 2023-06-01" \
                -d '{
                  "model": "claude-3-sonnet-20240229",
                  "max_tokens": 4000,
                  "messages": [
                    {
                      "role": "user", 
                      "content": "'"${INSTRUCTIONS} (ãƒ¢ãƒ¼ãƒ‰: ${MODE}, ç¬¬${ITER}å›ç›®)\n\nä»•æ§˜æ›¸:\n${SPEC_CONTENT}"'"
                    }
                  ]
                }')
              
              HTTP_CODE="${RESPONSE: -3}"
              if [ "$HTTP_CODE" = "200" ]; then
                STATUS=0
                echo "âœ… APIå‘¼ã³å‡ºã—æˆåŠŸ"
              else
                STATUS=1
                echo "âŒ APIå‘¼ã³å‡ºã—å¤±æ•— (HTTP $HTTP_CODE)"
              fi
            fi
            
            # çµæœå‡¦ç†
            if [ $STATUS -eq 0 ]; then
              echo "âœ… Claudeé–‹ç™ºãƒ«ãƒ¼ãƒ— $ITER å®Œäº†"
              SUCCESS_COUNT=$((SUCCESS_COUNT+1))
            else
              echo "âš ï¸ Claudeã‚¨ãƒ©ãƒ¼: ãƒ«ãƒ¼ãƒ— $ITER å¤±æ•—ï¼ˆçµ‚äº†ã‚³ãƒ¼ãƒ‰: $STATUSï¼‰"
              FAILED_COUNT=$((FAILED_COUNT+1))
              
              # é€£ç¶šå¤±æ•—ãƒã‚§ãƒƒã‚¯
              if [ $FAILED_COUNT -ge 3 ]; then
                echo "âŒ é€£ç¶š3å›å¤±æ•—ã®ãŸã‚ã€å®‰å…¨ã®ãŸã‚ãƒ«ãƒ¼ãƒ—ã‚’åœæ­¢ã—ã¾ã™"
                break
              fi
            fi
            
            echo "ğŸ“Š ç¾åœ¨ã®çŠ¶æ³: æˆåŠŸ $SUCCESS_COUNT å›, å¤±æ•— $FAILED_COUNT å›"
            ITER=$((ITER+1))
            
            # ãƒ¬ãƒ¼ãƒˆåˆ¶é™å¯¾ç­–
            if [ $ITER -le $CLAUDE_MAX_ITERATIONS ]; then
              echo "â³ ãƒ¬ãƒ¼ãƒˆåˆ¶é™å¯¾ç­–ã§10ç§’å¾…æ©Ÿ..."
              sleep 10
            fi
          done
          
          echo "======================================"
          echo "ğŸ‰ Claudeè‡ªå‹•é–‹ç™ºãƒ«ãƒ¼ãƒ—å®Œäº†"
          echo "ğŸ“ˆ æœ€çµ‚çµæœ: æˆåŠŸ $SUCCESS_COUNT å›, å¤±æ•— $FAILED_COUNT å›"
          echo "======================================"
          
      - name: ğŸ“Š Report Results
        if: always()
        run: |
          echo "======================================"
          echo "ğŸ“Š å®Ÿè¡Œçµæœãƒ¬ãƒãƒ¼ãƒˆ"
          echo "======================================"
          echo "å®Ÿè¡Œå®Œäº†æ™‚åˆ»: $(date '+%Y-%m-%d %H:%M:%S JST')"
          echo "å®Ÿè¡Œè€…: ${{ github.actor }}"
          echo "ã‚¤ãƒ™ãƒ³ãƒˆ: ${{ github.event_name }}"
          echo "ãƒªãƒã‚¸ãƒˆãƒª: ${{ github.repository }}"
          echo "ãƒ–ãƒ©ãƒ³ãƒ: ${{ github.ref_name }}"
          
          # ç”Ÿæˆã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã®ç¢ºèª
          echo "ğŸ“ æ–°è¦ä½œæˆãƒ»æ›´æ–°ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«:"
          find . -newer "$SPEC_FILE" -type f 2>/dev/null | head -10 || echo "æ–°è¦ãƒ•ã‚¡ã‚¤ãƒ«ãªã—"
          
          echo "GitHub Actionså®Ÿè¡Œãƒ­ã‚°ã‚’ç¢ºèªã—ã¦ãã ã•ã„"
          
      - name: ğŸ’¾ Commit Changes
        if: success()
        run: |
          echo "ğŸ’¾ å¤‰æ›´å†…å®¹ã‚’ã‚³ãƒŸãƒƒãƒˆä¸­..."
          
          git config --local user.email "kensan1969@gmail.com"
          git config --local user.name "Kensan196948G"
          
          # å¤‰æ›´ãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
          if git diff --quiet && git diff --staged --quiet; then
            echo "ğŸ“ ã‚³ãƒŸãƒƒãƒˆã™ã‚‹å¤‰æ›´ãŒã‚ã‚Šã¾ã›ã‚“"
          else
            git add -A
            
            # ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ä½œæˆ
            COMMIT_MSG="ğŸ¤– Claude Auto Development: $(date '+%Y-%m-%d %H:%M:%S JST')"
            if [ "${{ github.event_name }}" = "issue_comment" ]; then
              COMMIT_MSG="$COMMIT_MSG - Issue #${{ github.event.issue.number }} ã‹ã‚‰ã®å®Ÿè¡Œ"
            elif [ "${{ github.event_name }}" = "schedule" ]; then
              COMMIT_MSG="$COMMIT_MSG - ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«å®Ÿè¡Œ"
            fi
            
            git commit -m "$COMMIT_MSG"
            git push
            echo "âœ… ã‚³ãƒŸãƒƒãƒˆå®Œäº†"
          fi
          
      - name: ğŸ“‹ Archive Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: claude-development-results-${{ github.run_number }}
          path: |
            **/*.py
            **/*.js
            **/*.md
            **/*.txt
            **/*.yml
            **/*.yaml
            **/*.json
          retention-days: 30
