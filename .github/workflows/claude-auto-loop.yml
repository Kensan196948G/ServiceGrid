name: Claude Complete Auto Development

on:
  issue_comment:
    types: [created]
  workflow_dispatch:
    inputs:
      instructions:
        description: 'Claude ã¸ã®æ—¥æœ¬èªæŒ‡ç¤º'
        required: false
        default: 'åŒ…æ‹¬çš„ãªã‚·ã‚¹ãƒ†ãƒ è¨ºæ–­ã¨è‡ªå‹•æ”¹å–„ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„'
      mode:
        description: 'å®Ÿè¡Œãƒ¢ãƒ¼ãƒ‰'
        required: true
        default: 'full-auto'
        type: choice
        options:
          - full-auto
          - safe-mode
          - aggressive
  schedule:
    - cron: '0 */6 * * *'

env:
  CLAUDE_AUTO_APPROVE: "true"
  CLAUDE_NO_PROMPTS: "true"
  CLAUDE_SILENT_MODE: "true"
  CLAUDE_LANGUAGE: "ja"
  CLAUDE_MAX_ITERATIONS: "5"
  CLAUDE_TIMEOUT: "3600"
  TZ: 'Asia/Tokyo'

jobs:
  claude-complete-automation:
    if: |
      github.event_name == 'workflow_dispatch' ||
      github.event_name == 'schedule' ||
      (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@claude'))
    runs-on: ubuntu-latest
    timeout-minutes: 60

    permissions:
      contents: write
      issues: write
      pull-requests: write

    steps:
      - name: ğŸš€ Repository Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ”§ Environment Setup
        run: |
          echo "Claudeå®Œå…¨è‡ªå‹•åŒ–ç’°å¢ƒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ä¸­..."
          sudo apt-get update && sudo apt-get install -y jq curl git bc

      - name: ğŸ“ Find Latest Spec File
        id: specfile
        run: |
          FILE=$(ls -1 *æœ€æ–°ç‰ˆ*.txt 2>/dev/null | head -n 1)
          if [ -z "$FILE" ]; then
            FILE=$(ls -1 "ITSMæº–æ‹ ITé‹ç”¨ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ  è©³ç´°ä»•æ§˜æ›¸.txt" 2>/dev/null || true)
          fi
          if [ -z "$FILE" ]; then
            echo "âš ï¸ ä»•æ§˜æ›¸ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆ.txtï¼‰ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
            exit 1
          fi
          echo "SPEC_FILE=$FILE" >> $GITHUB_ENV
          echo "ä½¿ç”¨ã™ã‚‹ä»•æ§˜æ›¸ãƒ•ã‚¡ã‚¤ãƒ«: $FILE"

      - name: ğŸ—ï¸ Parse Claude Command Options
        if: github.event_name == 'issue_comment'
        id: parseclaude
        run: |
          # ã‚³ãƒ¡ãƒ³ãƒˆæœ¬æ–‡ã‚’å–å¾—
          COMMENT="${{ github.event.comment.body }}"
          # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤
          CLAUDE_OPTS="--auto-approve --no-prompts --silent-mode --mode full-auto"
          INSTRUCTIONS="åŒ…æ‹¬çš„ãªã‚·ã‚¹ãƒ†ãƒ è¨ºæ–­ã¨è‡ªå‹•æ”¹å–„ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„"
          # @claudeã‚³ãƒãƒ³ãƒ‰è¡Œã®ã¿ã‚’æŠ½å‡º
          CMD_LINE=$(echo "$COMMENT" | grep '@claude')
          if [ -n "$CMD_LINE" ]; then
            # --mode ã‚„ --instructions ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’æŠ½å‡ºï¼ˆå¿…è¦ã«å¿œã˜ã¦æ‹¡å¼µï¼‰
            if echo "$CMD_LINE" | grep -q -- '--mode'; then
              MODE=$(echo "$CMD_LINE" | sed -n 's/.*--mode[ =]\?\([^ ]*\).*/\1/p')
              [ -n "$MODE" ] && CLAUDE_OPTS=$(echo "$CLAUDE_OPTS" | sed "s/--mode [^ ]*/--mode $MODE/")
            fi
            if echo "$CMD_LINE" | grep -q -- '--instructions'; then
              INSTRUCTIONS=$(echo "$CMD_LINE" | sed -n 's/.*--instructions[ =]\?\([^ ]*\).*/\1/p')
            fi
          fi
          echo "CLAUDE_OPTS=$CLAUDE_OPTS" >> $GITHUB_ENV
          echo "INSTRUCTIONS=$INSTRUCTIONS" >> $GITHUB_ENV
          echo "ãƒ‘ãƒ¼ã‚¹çµæœ: $CLAUDE_OPTS / $INSTRUCTIONS"

      - name: ğŸ¤– Claude Auto Loop Execution
        env:
          CLAUDE_API_KEY: ${{ secrets.CLAUDE_API_KEY }}
        run: |
          echo "ğŸš€ Claudeè‡ªå‹•é–‹ç™ºãƒ»ä¿®å¾©ãƒ«ãƒ¼ãƒ—é–‹å§‹"
          ITER=1
          while [ $ITER -le $CLAUDE_MAX_ITERATIONS ]; do
            echo "----------------------"
            echo "ğŸŒ€ ãƒ«ãƒ¼ãƒ— $ITER å›ç›®"
            echo "----------------------"
            # ã‚³ãƒãƒ³ãƒ‰/ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’è‡ªå‹•é©ç”¨
            npx claude-cli \
              --file "$SPEC_FILE" \
              $CLAUDE_OPTS \
              --instructions "$INSTRUCTIONS" \
              --lang "ja"
            STATUS=$?
            if [ $STATUS -eq 0 ]; then
              echo "âœ… Claudeé–‹ç™ºãƒ«ãƒ¼ãƒ— $ITER å®Œäº†"
            else
              echo "âš ï¸ Claudeã‚¨ãƒ©ãƒ¼: ãƒ«ãƒ¼ãƒ— $ITER å¤±æ•—ã€æ¬¡ã«é€²ã¿ã¾ã™"
            fi
            ITER=$((ITER+1))
          done
          echo "ğŸ‰ Claudeè‡ªå‹•é–‹ç™ºãƒ«ãƒ¼ãƒ—å®Œäº†"

      - name: ğŸ“Š Report Results
        if: always()
        run: |
          echo "å®Ÿè¡Œå®Œäº†æ™‚åˆ»: $(date '+%Y-%m-%d %H:%M:%S JST')"
          echo "GitHub Actionså®Ÿè¡Œãƒ­ã‚°ã‚’ç¢ºèªã—ã¦ãã ã•ã„"

      - name: ğŸ’¾ Commit Changes
        if: success()
        run: |
          git config --local user.email "kensan1969@gmail.com"
          git config --local user.name "Kensan196948G"
          git add -A
          git diff --staged --quiet || git commit -m "ğŸ¤– Claude Auto Development: $(date '+%Y-%m-%d %H:%M:%S JST')"
          git push
