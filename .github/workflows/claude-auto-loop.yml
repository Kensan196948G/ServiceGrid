name: Claude Code Auto Loop
on:
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]
  issues:
    types: [opened, assigned]
  pull_request_review:
    types: [submitted]
  schedule:
    - cron: '0 */6 * * *'  # 6æ™‚é–“ã”ã¨ã®è‡ªå‹•ãƒã‚§ãƒƒã‚¯
  workflow_dispatch:  # æ‰‹å‹•å®Ÿè¡Œå¯¾å¿œ

env:
  # Claudeè‡ªå‹•åŒ–è¨­å®š
  CLAUDE_LANGUAGE: "ja"
  CLAUDE_MODE: "fully-automatic"
  CLAUDE_INTERACTION: "false"
  CLAUDE_AUTO_APPROVE: "true"
  CLAUDE_SILENT_MODE: "true"
  CLAUDE_AUTO_FIX: "true"
  CLAUDE_CONTINUOUS_IMPROVEMENT: "true"
  CLAUDE_SELF_HEALING: "true"

jobs:
  claude-auto-dev:
    if: |
      (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'pull_request_review_comment' && contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'pull_request_review' && contains(github.event.review.body, '@claude')) ||
      (github.event_name == 'issues' && (contains(github.event.issue.body, '@claude') || contains(github.event.issue.title, '@claude'))) ||
      (github.event_name == 'schedule') ||
      (github.event_name == 'workflow_dispatch')
    
    runs-on: ubuntu-latest
    timeout-minutes: 60
    
    permissions:
      contents: write
      issues: write
      pull-requests: write
      actions: write
      checks: write
      
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # å®Œå…¨ãªå±¥æ­´å–å¾—
          
      - name: Setup Claude Code Environment
        run: |
          echo "CLAUDE_CONFIG_PATH=.claude-automation-config.yml" >> $GITHUB_ENV
          echo "CLAUDE_WORKSPACE=${{ github.workspace }}" >> $GITHUB_ENV
          
      - name: Load Claude Configuration
        run: |
          if [ -f ".claude-automation-config.yml" ]; then
            echo "Claudeè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ"
            cat .claude-automation-config.yml
          else
            echo "ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®šã‚’ä½œæˆä¸­..."
            cat > .claude-automation-config.yml << 'EOF'
          automation:
            language: "ja"
            mode: "fully-automatic"
            interaction: false
            approval: auto
            continuous_loop: true
            
          development:
            auto_fix: true
            continuous_improvement: true
            self_healing: true
            code_review: automated
            testing: comprehensive
            
          monitoring:
            real_time: true
            predictive: true
            auto_response: true
            health_check: enabled
            
          quality:
            security_scan: continuous
            performance_test: automated
            compliance_check: enabled
            
          deployment:
            strategy: "blue-green"
            rollback: automatic
            monitoring: comprehensive
            
          notifications:
            slack: enabled
            teams: enabled
            email: critical-only
          EOF
          fi
          
      - name: Extract Claude Instructions
        id: extract_instructions
        run: |
          # GitHub Eventã‹ã‚‰ClaudeæŒ‡ç¤ºã‚’æŠ½å‡º
          INSTRUCTIONS=""
          if [ "${{ github.event_name }}" = "issue_comment" ]; then
            INSTRUCTIONS="${{ github.event.comment.body }}"
          elif [ "${{ github.event_name }}" = "pull_request_review_comment" ]; then
            INSTRUCTIONS="${{ github.event.comment.body }}"
          elif [ "${{ github.event_name }}" = "pull_request_review" ]; then
            INSTRUCTIONS="${{ github.event.review.body }}"
          elif [ "${{ github.event_name }}" = "issues" ]; then
            INSTRUCTIONS="${{ github.event.issue.body }}"
          elif [ "${{ github.event_name }}" = "schedule" ]; then
            INSTRUCTIONS="å®šæœŸçš„ãªã‚·ã‚¹ãƒ†ãƒ è¨ºæ–­ã¨è‡ªå‹•æ”¹å–„ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„"
          else
            INSTRUCTIONS="ãƒªãƒã‚¸ãƒˆãƒªã®å¥åº·çŠ¶æ…‹ã‚’ãƒã‚§ãƒƒã‚¯ã—ã€å¿…è¦ã«å¿œã˜ã¦æ”¹å–„ã—ã¦ãã ã•ã„"
          fi
          
          # @claudeéƒ¨åˆ†ã‚’æŠ½å‡ºã—ã¦æ•´ç†
          CLEANED_INSTRUCTIONS=$(echo "$INSTRUCTIONS" | grep -o '@claude.*' | sed 's/@claude//')
          echo "instructions=$CLEANED_INSTRUCTIONS" >> $GITHUB_OUTPUT
          
      - name: Run Claude Code with Full Automation
        uses: anthropics/claude-code-action@beta
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          instructions: |
            ${{ steps.extract_instructions.outputs.instructions }}
            
            ä»¥ä¸‹ã®å®Œå…¨è‡ªå‹•åŒ–è¨­å®šã§å®Ÿè¡Œã—ã¦ãã ã•ã„ï¼š
            --auto-approve --no-prompts --silent-mode --lang "ja"
            --config-file ".claude-automation-config.yml"
            --continuous-improvement --self-healing
            --auto-fix-errors --quality-gates-automated
            --monitoring-integration --documentation-auto-update
            
          allowed_tools: |
            mcp__github__create_issue,
            mcp__github__create_pull_request,
            mcp__github__merge_pull_request,
            mcp__github__create_commit,
            mcp__github__update_file,
            mcp__github__create_branch,
            Edit,Replace,View,Execute
            
      - name: Auto-healing Health Check
        if: always()
        run: |
          # ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹ã®ãƒã‚§ãƒƒã‚¯
          echo "ğŸ” ã‚·ã‚¹ãƒ†ãƒ å¥åº·çŠ¶æ…‹ãƒã‚§ãƒƒã‚¯å®Ÿè¡Œä¸­..."
          
          # ãƒ†ã‚¹ãƒˆã®å®Ÿè¡Œ
          if [ -f "package.json" ]; then
            npm test --if-present || echo "âš ï¸ ãƒ†ã‚¹ãƒˆå¤±æ•—ã‚’æ¤œå‡º"
          fi
          
          # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³
          if command -v npm &> /dev/null; then
            npm audit --audit-level=moderate || echo "âš ï¸ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è„†å¼±æ€§ã‚’æ¤œå‡º"
          fi
          
          # ã‚³ãƒ¼ãƒ‰å“è³ªãƒã‚§ãƒƒã‚¯
          if [ -f ".eslintrc*" ] || [ -f "eslint.config.*" ]; then
            npx eslint . --max-warnings 0 || echo "âš ï¸ ã‚³ãƒ¼ãƒ‰å“è³ªå•é¡Œã‚’æ¤œå‡º"
          fi
          
      - name: Continuous Improvement Trigger
        if: always()
        run: |
          # æ”¹å–„ææ¡ˆã®è‡ªå‹•ç”Ÿæˆ
          echo "ğŸ’¡ ç¶™ç¶šçš„æ”¹å–„ãƒ—ãƒ­ã‚»ã‚¹ã‚’é–‹å§‹..."
          
          # ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹åˆ†æçµæœã‚’ Issue ã¨ã—ã¦ä½œæˆ
          gh issue create \
            --title "ğŸ¤– è‡ªå‹•æ”¹å–„ææ¡ˆ - $(date '+%Y-%m-%d %H:%M')" \
            --body "ã‚·ã‚¹ãƒ†ãƒ åˆ†æçµæœã«åŸºã¥ãæ”¹å–„ææ¡ˆã‚’è‡ªå‹•ç”Ÿæˆã—ã¾ã—ãŸã€‚è©³ç´°ã¯æ·»ä»˜ã®ãƒ¬ãƒãƒ¼ãƒˆã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚" \
            --label "enhancement,automated,claude" || true
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Notification
        if: always()
        run: |
          echo "âœ… Claudeè‡ªå‹•åŒ–ã‚µã‚¤ã‚¯ãƒ«å®Œäº†"
          echo "ğŸ“Š å®Ÿè¡Œçµæœ: ${{ job.status }}"
          echo "ğŸ• å®Ÿè¡Œæ™‚é–“: $(date)"