name: Claude Complete Auto Development (APIç‰ˆ)

on:
  issue_comment:
    types: [created]
  workflow_dispatch:
    inputs:
      instructions:
        description: 'Claudeã¸ã®æ—¥æœ¬èªæŒ‡ç¤º'
        required: false
        default: 'åŒ…æ‹¬çš„ãªã‚·ã‚¹ãƒ†ãƒ è¨ºæ–­ã¨è‡ªå‹•æ”¹å–„ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„'
      mode:
        description: 'å®Ÿè¡Œãƒ¢ãƒ¼ãƒ‰'
        required: true
        default: 'full-auto'
        type: choice
        options:
          - full-auto
          - safe-mode
          - aggressive
  schedule:
    - cron: '0 */6 * * *'

env:
  CLAUDE_MAX_ITERATIONS: "5"
  TZ: 'Asia/Tokyo'

jobs:
  claude-api-automation:
    if: |
      github.event_name == 'workflow_dispatch' ||
      github.event_name == 'schedule' ||
      (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@claude'))
    runs-on: ubuntu-latest
    timeout-minutes: 60
    permissions:
      contents: write
      issues: write
      pull-requests: write
      
    steps:
      - name: ğŸš€ Repository Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
          
      - name: ğŸ”§ åŸºæœ¬ç’°å¢ƒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        run: |
          echo "åŸºæœ¬ç’°å¢ƒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ä¸­..."
          sudo apt-get update && sudo apt-get install -y jq curl git bc
          
          echo "ç’°å¢ƒç¢ºèª:"
          echo "  - jq: $(jq --version)"
          echo "  - curl: $(curl --version | head -1)"
          echo "  - git: $(git --version)"
          echo "âœ… åŸºæœ¬ç’°å¢ƒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—å®Œäº†"
          
      - name: ğŸ“ Find Latest Spec File
        id: specfile
        run: |
          echo "ğŸ” ä»•æ§˜æ›¸ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ¤œç´¢ä¸­..."
          
          SPEC_FILE=""
          
          # å„ªå…ˆé †ä½ä»˜ãã§ãƒ•ã‚¡ã‚¤ãƒ«æ¤œç´¢
          if [ -z "$SPEC_FILE" ]; then
            SPEC_FILE=$(find . -name "*æœ€æ–°ç‰ˆ*.txt" -type f | head -n 1)
          fi
          
          if [ -z "$SPEC_FILE" ]; then
            SPEC_FILE=$(find . -name "*ITSM*ä»•æ§˜æ›¸*.txt" -type f | head -n 1)
          fi
          
          if [ -z "$SPEC_FILE" ]; then
            SPEC_FILE=$(find . -name "*ä»•æ§˜æ›¸*.txt" -type f | head -n 1)
          fi
          
          # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆä»•æ§˜æ›¸ä½œæˆ
          if [ -z "$SPEC_FILE" ]; then
            SPEC_FILE="itsm_platform_spec.txt"
            cat > "$SPEC_FILE" << 'EOF'
          ITSMæº–æ‹ ITé‹ç”¨ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ é–‹ç™ºä»•æ§˜æ›¸
          
          ## æ¦‚è¦
          ä¼æ¥­ã®ITé‹ç”¨ã‚’åŒ…æ‹¬çš„ã«ç®¡ç†ã™ã‚‹ITSMï¼ˆIT Service Managementï¼‰æº–æ‹ ã®ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã‚’é–‹ç™ºã™ã‚‹ã€‚
          
          ## ä¸»è¦æ©Ÿèƒ½è¦ä»¶
          1. ã‚¤ãƒ³ã‚·ãƒ‡ãƒ³ãƒˆç®¡ç†æ©Ÿèƒ½
          2. å•é¡Œç®¡ç†æ©Ÿèƒ½
          3. å¤‰æ›´ç®¡ç†æ©Ÿèƒ½
          4. ãƒªãƒªãƒ¼ã‚¹ç®¡ç†æ©Ÿèƒ½
          5. æ§‹æˆç®¡ç†æ©Ÿèƒ½
          6. ã‚µãƒ¼ãƒ“ã‚¹ãƒ¬ãƒ™ãƒ«ç®¡ç†æ©Ÿèƒ½
          7. ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰æ©Ÿèƒ½
          8. ãƒ¬ãƒãƒ¼ãƒˆæ©Ÿèƒ½
          
          ## æŠ€è¡“è¦ä»¶
          - é«˜å¯ç”¨æ€§ï¼ˆ99.9%ä»¥ä¸Šï¼‰
          - ã‚¹ã‚±ãƒ¼ãƒ©ãƒ“ãƒªãƒ†ã‚£
          - ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æº–æ‹ 
          - APIé€£æºæ©Ÿèƒ½
          - è‡ªå‹•åŒ–æ©Ÿèƒ½
          
          ## å“è³ªè¦ä»¶
          - ãƒ¦ãƒ¼ã‚¶ãƒ“ãƒªãƒ†ã‚£
          - ä¿å®ˆæ€§
          - æ‹¡å¼µæ€§
          - ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹
          EOF
            echo "âš ï¸ ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆä»•æ§˜æ›¸ã‚’ä½œæˆã—ã¾ã—ãŸ: $SPEC_FILE"
          fi
          
          echo "SPEC_FILE=$SPEC_FILE" >> $GITHUB_ENV
          echo "âœ… ä½¿ç”¨ã™ã‚‹ä»•æ§˜æ›¸ãƒ•ã‚¡ã‚¤ãƒ«: $SPEC_FILE"
          echo "ğŸ“„ ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚º: $(wc -c < "$SPEC_FILE") bytes"
          
      - name: ğŸ—ï¸ Parse Input Parameters
        id: parse_params
        run: |
          echo "ğŸ”§ å®Ÿè¡Œãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’è¨­å®šä¸­..."
          
          MODE="full-auto"
          INSTRUCTIONS="åŒ…æ‹¬çš„ãªã‚·ã‚¹ãƒ†ãƒ è¨ºæ–­ã¨è‡ªå‹•æ”¹å–„ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„"
          
          # workflow_dispatch ã‹ã‚‰ã®å…¥åŠ›å€¤
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            if [ -n "${{ github.event.inputs.mode }}" ]; then
              MODE="${{ github.event.inputs.mode }}"
            fi
            if [ -n "${{ github.event.inputs.instructions }}" ]; then
              INSTRUCTIONS="${{ github.event.inputs.instructions }}"
            fi
          fi
          
          # issue_comment ã‹ã‚‰ã®è§£æ
          if [ "${{ github.event_name }}" = "issue_comment" ]; then
            COMMENT="${{ github.event.comment.body }}"
            
            if echo "$COMMENT" | grep -q -- '--mode'; then
              EXTRACTED_MODE=$(echo "$COMMENT" | sed -n 's/.*--mode[ =]\([^ ]*\).*/\1/p')
              if [ -n "$EXTRACTED_MODE" ]; then
                MODE="$EXTRACTED_MODE"
              fi
            fi
            
            if echo "$COMMENT" | grep -q -- '--instructions'; then
              EXTRACTED_INSTRUCTIONS=$(echo "$COMMENT" | sed -n 's/.*--instructions[ =]"\([^"]*\)".*/\1/p')
              if [ -n "$EXTRACTED_INSTRUCTIONS" ]; then
                INSTRUCTIONS="$EXTRACTED_INSTRUCTIONS"
              fi
            fi
          fi
          
          echo "MODE=$MODE" >> $GITHUB_ENV
          echo "INSTRUCTIONS=$INSTRUCTIONS" >> $GITHUB_ENV
          
          echo "ğŸ“‹ å®Ÿè¡Œè¨­å®š:"
          echo "  - ãƒ¢ãƒ¼ãƒ‰: $MODE"
          echo "  - æŒ‡ç¤º: $INSTRUCTIONS"
          
      - name: ğŸ¤– Claude APIç›´æ¥å®Ÿè¡Œãƒ«ãƒ¼ãƒ—
        env:
          ANTHROPIC_API_KEY: ${{ secrets.CLAUDE_API_KEY }}
        run: |
          echo "ğŸš€ Claude APIç›´æ¥å®Ÿè¡Œãƒ«ãƒ¼ãƒ—é–‹å§‹"
          
          # API ã‚­ãƒ¼ç¢ºèª
          if [ -z "$ANTHROPIC_API_KEY" ]; then
            echo "âŒ ANTHROPIC_API_KEY ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“"
            echo "GitHub Secrets ã« CLAUDE_API_KEY ã‚’è¨­å®šã—ã¦ãã ã•ã„"
            exit 1
          fi
          
          # ãƒ•ã‚¡ã‚¤ãƒ«å­˜åœ¨ç¢ºèª
          if [ ! -f "$SPEC_FILE" ]; then
            echo "âŒ ä»•æ§˜æ›¸ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: $SPEC_FILE"
            exit 1
          fi
          
          echo "ğŸ“‹ å®Ÿè¡Œç’°å¢ƒ:"
          echo "  - ä»•æ§˜æ›¸: $SPEC_FILE"
          echo "  - ãƒ¢ãƒ¼ãƒ‰: $MODE"
          echo "  - æœ€å¤§åå¾©: $CLAUDE_MAX_ITERATIONS"
          echo "  - æŒ‡ç¤º: $INSTRUCTIONS"
          
          # ä»•æ§˜æ›¸å†…å®¹èª­ã¿è¾¼ã¿ï¼ˆæ–‡å­—æ•°åˆ¶é™å¯¾ç­–ï¼‰
          SPEC_CONTENT=$(head -c 6000 "$SPEC_FILE")
          
          # ãƒ¡ã‚¤ãƒ³ãƒ«ãƒ¼ãƒ—
          ITER=1
          SUCCESS_COUNT=0
          FAILED_COUNT=0
          
          while [ $ITER -le $CLAUDE_MAX_ITERATIONS ]; do
            echo "======================================"
            echo "ğŸŒ€ Claude APIå®Ÿè¡Œ $ITER å›ç›®"
            echo "======================================"
            
            # APIãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ä½œæˆ
            PROMPT="ã€Claudeè‡ªå‹•é–‹ç™ºã‚·ã‚¹ãƒ†ãƒ  - å®Ÿè¡Œ ${ITER}/${CLAUDE_MAX_ITERATIONS}ã€‘

          ğŸ¯ å®Ÿè¡ŒæŒ‡ç¤º: ${INSTRUCTIONS}
          ğŸ”§ å®Ÿè¡Œãƒ¢ãƒ¼ãƒ‰: ${MODE}
          ğŸ“… å®Ÿè¡Œæ™‚åˆ»: $(date '+%Y-%m-%d %H:%M:%S JST')
          
          ä»¥ä¸‹ã®ä»•æ§˜æ›¸ã«åŸºã¥ã„ã¦ã€ITSMæº–æ‹ ã®ITé‹ç”¨ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã®é–‹ç™ºãƒ»æ”¹å–„ã‚’è¡Œã£ã¦ãã ã•ã„ã€‚
          
          å…·ä½“çš„ã«ä»¥ä¸‹ã®ä½œæ¥­ã‚’å®Ÿæ–½ã—ã¦ãã ã•ã„ï¼š
          1. ç¾åœ¨ã®é€²æ—çŠ¶æ³ã®åˆ†æ
          2. æ¬¡ã«å®Ÿè£…ã™ã¹ãæ©Ÿèƒ½ã®ç‰¹å®š
          3. ã‚³ãƒ¼ãƒ‰ãƒ»è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®ç”Ÿæˆ
          4. ãƒ†ã‚¹ãƒˆè¨ˆç”»ã®ç­–å®š
          5. æ”¹å–„ææ¡ˆã®ä½œæˆ
          
          ã€ä»•æ§˜æ›¸å†…å®¹ã€‘
          ${SPEC_CONTENT}
          
          ã€æ³¨æ„äº‹é …ã€‘
          - å®Ÿç”¨çš„ã§å‹•ä½œã™ã‚‹ã‚³ãƒ¼ãƒ‰ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„
          - ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹ã«å¾“ã£ã¦ãã ã•ã„
          - æ—¥æœ¬èªã§ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’ä½œæˆã—ã¦ãã ã•ã„
          - å‰å›ã¾ã§ã®æˆæœã‚’è€ƒæ…®ã—ã¦ç¶™ç¶šçš„ãªæ”¹å–„ã‚’è¡Œã£ã¦ãã ã•ã„"
            
            # APIå‘¼ã³å‡ºã—å®Ÿè¡Œ
            RESPONSE=$(curl -s -w "\n%{http_code}" -X POST https://api.anthropic.com/v1/messages \
              -H "Content-Type: application/json" \
              -H "x-api-key: $ANTHROPIC_API_KEY" \
              -H "anthropic-version: 2023-06-01" \
              -d "{
                \"model\": \"claude-3-sonnet-20240229\",
                \"max_tokens\": 4000,
                \"messages\": [
                  {
                    \"role\": \"user\", 
                    \"content\": $(echo "$PROMPT" | jq -Rs .)
                  }
                ]
              }")
            
            # ãƒ¬ã‚¹ãƒãƒ³ã‚¹è§£æ
            HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
            RESPONSE_BODY=$(echo "$RESPONSE" | head -n -1)
            
            if [ "$HTTP_CODE" = "200" ]; then
              STATUS=0
              SUCCESS_COUNT=$((SUCCESS_COUNT+1))
              echo "âœ… Claude APIå‘¼ã³å‡ºã—æˆåŠŸ"
              
              # ãƒ¬ã‚¹ãƒãƒ³ã‚¹ä¿å­˜ãƒ»å‡¦ç†
              OUTPUT_DIR="claude_results"
              mkdir -p "$OUTPUT_DIR"
              
              TIMESTAMP=$(date '+%Y%m%d_%H%M%S')
              RESPONSE_FILE="${OUTPUT_DIR}/response_${ITER}_${TIMESTAMP}.json"
              OUTPUT_FILE="${OUTPUT_DIR}/output_${ITER}_${TIMESTAMP}.md"
              
              echo "$RESPONSE_BODY" > "$RESPONSE_FILE"
              
              # å¿œç­”å†…å®¹æŠ½å‡º
              if echo "$RESPONSE_BODY" | jq -e '.content[0].text' > /dev/null 2>&1; then
                CLAUDE_OUTPUT=$(echo "$RESPONSE_BODY" | jq -r '.content[0].text')
                echo "$CLAUDE_OUTPUT" > "$OUTPUT_FILE"
                
                echo "ğŸ“ Claudeå¿œç­”æ¦‚è¦:"
                echo "$CLAUDE_OUTPUT" | head -10
                echo "..."
                echo "ğŸ’¾ å®Œå…¨ãªå¿œç­”ã‚’ä¿å­˜: $OUTPUT_FILE"
                
                # ä½¿ç”¨é‡æƒ…å ±
                if echo "$RESPONSE_BODY" | jq -e '.usage' > /dev/null 2>&1; then
                  INPUT_TOKENS=$(echo "$RESPONSE_BODY" | jq -r '.usage.input_tokens // "N/A"')
                  OUTPUT_TOKENS=$(echo "$RESPONSE_BODY" | jq -r '.usage.output_tokens // "N/A"')
                  echo "ğŸ“Š APIä½¿ç”¨é‡: å…¥åŠ› $INPUT_TOKENS ãƒˆãƒ¼ã‚¯ãƒ³, å‡ºåŠ› $OUTPUT_TOKENS ãƒˆãƒ¼ã‚¯ãƒ³"
                fi
              else
                echo "âš ï¸ ãƒ¬ã‚¹ãƒãƒ³ã‚¹å½¢å¼ã®è§£æã«å¤±æ•—"
                echo "$RESPONSE_BODY" > "$OUTPUT_FILE"
              fi
              
            else
              STATUS=1
              FAILED_COUNT=$((FAILED_COUNT+1))
              echo "âŒ Claude APIå‘¼ã³å‡ºã—å¤±æ•— (HTTP $HTTP_CODE)"
              echo "ã‚¨ãƒ©ãƒ¼è©³ç´°:"
              echo "$RESPONSE_BODY" | jq . 2>/dev/null || echo "$RESPONSE_BODY"
              
              # é€£ç¶šå¤±æ•—ãƒã‚§ãƒƒã‚¯
              if [ $FAILED_COUNT -ge 3 ]; then
                echo "âŒ é€£ç¶š3å›å¤±æ•—ã®ãŸã‚ã€å®‰å…¨ã®ãŸã‚ãƒ«ãƒ¼ãƒ—ã‚’åœæ­¢ã—ã¾ã™"
                break
              fi
            fi
            
            echo "ğŸ“Š ç¾åœ¨ã®çŠ¶æ³: æˆåŠŸ $SUCCESS_COUNT å›, å¤±æ•— $FAILED_COUNT å›"
            ITER=$((ITER+1))
            
            # ãƒ¬ãƒ¼ãƒˆåˆ¶é™å¯¾ç­–
            if [ $ITER -le $CLAUDE_MAX_ITERATIONS ]; then
              echo "â³ APIåˆ¶é™å¯¾ç­–ã§20ç§’å¾…æ©Ÿ..."
              sleep 20
            fi
          done
          
          echo "======================================"
          echo "ğŸ‰ Claude APIè‡ªå‹•å®Ÿè¡Œãƒ«ãƒ¼ãƒ—å®Œäº†"
          echo "ğŸ“ˆ æœ€çµ‚çµæœ: æˆåŠŸ $SUCCESS_COUNT å›, å¤±æ•— $FAILED_COUNT å›"
          echo "======================================"
          
      - name: ğŸ“Š å®Ÿè¡Œçµæœãƒ¬ãƒãƒ¼ãƒˆ
        if: always()
        run: |
          echo "======================================"
          echo "ğŸ“Š å®Ÿè¡Œçµæœãƒ¬ãƒãƒ¼ãƒˆ"
          echo "======================================"
          echo "å®Ÿè¡Œå®Œäº†æ™‚åˆ»: $(date '+%Y-%m-%d %H:%M:%S JST')"
          echo "å®Ÿè¡Œè€…: ${{ github.actor }}"
          echo "ã‚¤ãƒ™ãƒ³ãƒˆ: ${{ github.event_name }}"
          echo "ãƒªãƒã‚¸ãƒˆãƒª: ${{ github.repository }}"
          echo "ãƒ–ãƒ©ãƒ³ãƒ: ${{ github.ref_name }}"
          
          # ç”Ÿæˆãƒ•ã‚¡ã‚¤ãƒ«ç¢ºèª
          if [ -d "claude_results" ]; then
            echo "ğŸ“ ç”Ÿæˆã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«:"
            ls -la claude_results/
            echo "ğŸ“„ ãƒ•ã‚¡ã‚¤ãƒ«æ•°: $(ls claude_results/ | wc -l)"
          else
            echo "ğŸ“ ç”Ÿæˆãƒ•ã‚¡ã‚¤ãƒ«ãªã—"
          fi
          
      - name: ğŸ’¾ å¤‰æ›´å†…å®¹ã‚³ãƒŸãƒƒãƒˆ
        if: success()
        run: |
          echo "ğŸ’¾ å¤‰æ›´å†…å®¹ã‚’ã‚³ãƒŸãƒƒãƒˆä¸­..."
          
          git config --local user.email "kensan1969@gmail.com"
          git config --local user.name "Kensan196948G"
          
          # å¤‰æ›´ãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
          if git diff --quiet && git diff --staged --quiet; then
            echo "ğŸ“ æ–°ã—ã„å¤‰æ›´ãŒã‚ã‚Šã¾ã›ã‚“"
          else
            git add -A
            
            COMMIT_MSG="ğŸ¤– Claude Auto Development (API): $(date '+%Y-%m-%d %H:%M:%S JST')"
            if [ "${{ github.event_name }}" = "issue_comment" ]; then
              COMMIT_MSG="$COMMIT_MSG - Issue #${{ github.event.issue.number }} çµŒç”±"
            elif [ "${{ github.event_name }}" = "schedule" ]; then
              COMMIT_MSG="$COMMIT_MSG - å®šæœŸå®Ÿè¡Œ"
            fi
            
            git commit -m "$COMMIT_MSG"
            git push
            echo "âœ… ã‚³ãƒŸãƒƒãƒˆãƒ»ãƒ—ãƒƒã‚·ãƒ¥å®Œäº†"
          fi
          
      - name: ğŸ“‹ çµæœã‚¢ãƒ¼ã‚«ã‚¤ãƒ–
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: claude-api-results-${{ github.run_number }}
          path: |
            claude_results/
            **/*.py
            **/*.js
            **/*.md
            **/*.txt
            **/*.yml
            **/*.yaml
            **/*.json
          retention-days: 30
