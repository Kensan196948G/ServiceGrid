name: Claude Complete Auto Development

on:
  issue_comment:
    types: [created]
  workflow_dispatch:
    inputs:
      instructions:
        description: 'Claudeへの日本語指示'
        required: false
        default: '包括的なシステム診断と自動改善を実行してください'
      mode:
        description: '実行モード'
        required: true
        default: 'full-auto'
        type: choice
        options:
          - full-auto
          - safe-mode
          - aggressive
  schedule:
    - cron: '0 */6 * * *'

env:
  CLAUDE_MAX_ITERATIONS: "5"
  TZ: 'Asia/Tokyo'

jobs:
  claude-complete-automation:
    if: |
      github.event_name == 'workflow_dispatch' ||
      github.event_name == 'schedule' ||
      (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@claude'))
    runs-on: ubuntu-latest
    timeout-minutes: 60

    permissions:
      contents: write
      issues: write
      pull-requests: write

    steps:
      - name: 🚀 Repository Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: 🔧 Environment Setup
        run: |
          echo "Claude公式CLI環境セットアップ中..."
          sudo apt-get update && sudo apt-get install -y jq curl git bc
          npm install -g @anthropic-ai/claude-code

      - name: 📝 Find Latest Spec File
        id: specfile
        run: |
          FILE=$(ls -1 *最新版*.txt 2>/dev/null | head -n 1)
          if [ -z "$FILE" ]; then
            FILE=$(ls -1 "ITSM準拠IT運用システムプラットフォーム 詳細仕様書.txt" 2>/dev/null || true)
          fi
          if [ -z "$FILE" ]; then
            echo "⚠️ 仕様書ファイル（.txt）が見つかりません"
            exit 1
          fi
          echo "SPEC_FILE=$FILE" >> $GITHUB_ENV
          echo "使用する仕様書ファイル: $FILE"

      - name: 🗝️ Parse Claude Command Options
        if: github.event_name == 'issue_comment'
        id: parseclaude
        run: |
          COMMENT="${{ github.event.comment.body }}"
          MODE="full-auto"
          INSTRUCTIONS="包括的なシステム診断と自動改善を実行してください"
          if echo "$COMMENT" | grep -q -- '--mode'; then
            MODE=$(echo "$COMMENT" | sed -n 's/.*--mode[ =]\?\([^ ]*\).*/\1/p')
          fi
          if echo "$COMMENT" | grep -q -- '--instructions'; then
            INSTRUCTIONS=$(echo "$COMMENT" | sed -n 's/.*--instructions[ =]\?\([^ ]*\).*/\1/p')
          fi
          echo "MODE=$MODE" >> $GITHUB_ENV
          echo "INSTRUCTIONS=$INSTRUCTIONS" >> $GITHUB_ENV

      - name: 🤖 Claude Auto Loop Execution
        env:
          CLAUDE_API_KEY: ${{ secrets.CLAUDE_API_KEY }}
        run: |
          echo "🚀 Claude自動開発・修復ループ開始"
          ITER=1
          while [ $ITER -le $CLAUDE_MAX_ITERATIONS ]; do
            echo "----------------------"
            echo "🌀 ループ $ITER 回目"
            echo "----------------------"
            claude-code \
              --file "$SPEC_FILE" \
              --instructions "$INSTRUCTIONS" \
              --lang "ja" \
              --auto-approve \
              --no-prompts \
              --silent-mode \
              --mode "$MODE"
            STATUS=$?
            if [ $STATUS -eq 0 ]; then
              echo "✅ Claude開発ループ $ITER 完了"
            else
              echo "⚠️ Claudeエラー: ループ $ITER 失敗、次に進みます"
            fi
            ITER=$((ITER+1))
          done
          echo "🎉 Claude自動開発ループ完了"

      - name: 📊 Report Results
        if: always()
        run: |
          echo "実行完了時刻: $(date '+%Y-%m-%d %H:%M:%S JST')"
          echo "GitHub Actions実行ログを確認してください"

      - name: 💾 Commit Changes
        if: success()
        run: |
          git config --local user.email "kensan1969@gmail.com"
          git config --local user.name "Kensan196948G"
          git add -A
          git diff --staged --quiet || git commit -m "🤖 Claude Auto Development: $(date '+%Y-%m-%d %H:%M:%S JST')"
          git push