#!/bin/bash

# Feature-B: UI/ãƒ†ã‚¹ãƒˆè‡ªå‹•ä¿®å¾©
# React/TypeScriptãƒ»Jest/RTLãƒ»ESLintãƒ»è‡ªå‹•ä¿®å¾©ãƒ»Worktreeé€£æº

set -e

PROJECT_ROOT="/mnt/e/ServiceGrid"
WORKTREE_ROOT="$PROJECT_ROOT/worktrees"
UI_WORKTREE="$WORKTREE_ROOT/feature-b-ui"
FEATURE_NAME="Feature-B: UI/ãƒ†ã‚¹ãƒˆè‡ªå‹•ä¿®å¾© (Worktreeå¯¾å¿œ)"

# è‰²ä»˜ããƒ¡ãƒƒã‚»ãƒ¼ã‚¸é–¢æ•°
print_header() {
    echo -e "\033[1;32m========================================\033[0m"
    echo -e "\033[1;32m  $FEATURE_NAME\033[0m"
    echo -e "\033[1;32m========================================\033[0m"
}

print_info() {
    echo -e "\033[1;34m[INFO]\033[0m $1"
}

print_success() {
    echo -e "\033[1;32m[SUCCESS]\033[0m $1"
}

print_error() {
    echo -e "\033[1;31m[ERROR]\033[0m $1"
}

print_warning() {
    echo -e "\033[1;33m[WARNING]\033[0m $1"
}

# WorktreeåˆæœŸåŒ–ãƒ»ç§»å‹•
init_ui_worktree() {
    print_info "UI/ãƒ†ã‚¹ãƒˆç”¨Worktreeã‚’åˆæœŸåŒ–ä¸­..."
    
    if [ ! -d "$UI_WORKTREE" ]; then
        print_warning "UI WorktreeãŒæœªä½œæˆã§ã™ã€‚"
        
        # Worktreeç®¡ç†ãƒ„ãƒ¼ãƒ«ãŒå­˜åœ¨ã™ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
        if [ -f "$PROJECT_ROOT/tmux/tools/worktree-manager.sh" ]; then
            print_info "Worktreeç®¡ç†ãƒ„ãƒ¼ãƒ«ã§ä½œæˆã‚’è©¦è¡Œã—ã¾ã™..."
            bash "$PROJECT_ROOT/tmux/tools/worktree-manager.sh" init
            
            if [ ! -d "$UI_WORKTREE" ]; then
                print_warning "UI Worktreeã®ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ"
                print_info "ãƒ¡ã‚¤ãƒ³ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã§ä½œæ¥­ã‚’ç¶šè¡Œã—ã¾ã™"
                cd "$PROJECT_ROOT"
                return
            fi
        else
            print_warning "Worktreeç®¡ç†ãƒ„ãƒ¼ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
            print_info "ãƒ¡ã‚¤ãƒ³ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã§ä½œæ¥­ã‚’ç¶šè¡Œã—ã¾ã™"
            cd "$PROJECT_ROOT"
            return
        fi
    fi
    
    cd "$UI_WORKTREE"
    print_success "UI/ãƒ†ã‚¹ãƒˆWorktreeã«ç§»å‹•ã—ã¾ã—ãŸ: $UI_WORKTREE"
    
    # ä¾å­˜é–¢ä¿‚ç¢ºèª
    if [ ! -d "node_modules" ]; then
        print_info "ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ä¸­..."
        npm install
    fi
}

# å®šæœŸWorktreeåŒæœŸ
auto_sync_worktree() {
    print_info "UIãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã‚’è‡ªå‹•åŒæœŸä¸­..."
    
    cd "$UI_WORKTREE"
    
    # å¤‰æ›´ãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
    if ! git diff --quiet || ! git diff --cached --quiet; then
        print_info "å¤‰æ›´ã‚’è‡ªå‹•ã‚³ãƒŸãƒƒãƒˆä¸­..."
        git add -A
        git commit -m "Auto-commit UI/Test work: $(date '+%Y-%m-%d %H:%M:%S')

UI/ãƒ†ã‚¹ãƒˆè‡ªå‹•ä¿®å¾©ã«ã‚ˆã‚‹å¤‰æ›´:
- React ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆæ›´æ–°
- ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹è¿½åŠ ãƒ»ä¿®æ­£
- ESLint è‡ªå‹•ä¿®æ­£é©ç”¨

ğŸ¤– Generated by Feature-B UI/Test pane"
        
        # ãƒªãƒ¢ãƒ¼ãƒˆåŒæœŸ
        bash "$PROJECT_ROOT/tmux/tools/sync-worktrees.sh" sync feature-b-ui true
        print_success "UI/ãƒ†ã‚¹ãƒˆå¤‰æ›´ã‚’åŒæœŸã—ã¾ã—ãŸ"
    else
        print_info "åŒæœŸã™ã‚‹å¤‰æ›´ã¯ã‚ã‚Šã¾ã›ã‚“"
    fi
}

# UIé–‹ç™ºãƒ¡ãƒ‹ãƒ¥ãƒ¼è¡¨ç¤º
show_ui_menu() {
    echo ""
    echo "ğŸ¨ UI/ãƒ†ã‚¹ãƒˆè‡ªå‹•ä¿®å¾© - æ“ä½œãƒ¡ãƒ‹ãƒ¥ãƒ¼"
    echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
    echo "1) ğŸš€ ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰é–‹ç™ºã‚µãƒ¼ãƒãƒ¼èµ·å‹•"
    echo "2) ğŸ§ª ãƒ†ã‚¹ãƒˆwatchå®Ÿè¡Œ"
    echo "3) âœ¨ ESLintè‡ªå‹•ä¿®å¾©"
    echo "4) ğŸ” TypeScriptå‹ãƒã‚§ãƒƒã‚¯"
    echo "5) ğŸ“Š ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸è¡¨ç¤º"
    echo "6) ğŸ”§ ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆè‡ªå‹•ä¿®å¾©"
    echo "7) ğŸ“± UIå‹•ä½œç¢ºèª"
    echo "8) ğŸ”„ ä¾å­˜é–¢ä¿‚æ›´æ–°"
    echo "9) ğŸ“ ãƒ†ã‚¹ãƒˆè‡ªå‹•ç”Ÿæˆ"
    echo "a) ğŸ¯ å…¨è‡ªå‹•ä¿®å¾©ãƒ¢ãƒ¼ãƒ‰"
    echo "0) ğŸ”„ ãƒ¡ãƒ‹ãƒ¥ãƒ¼å†è¡¨ç¤º"
    echo "q) çµ‚äº†"
    echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
}

# ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰é–‹ç™ºã‚µãƒ¼ãƒãƒ¼èµ·å‹•
start_dev_server() {
    print_info "ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰é–‹ç™ºã‚µãƒ¼ãƒãƒ¼ã‚’èµ·å‹•ä¸­..."
    
    cd "$PROJECT_ROOT"
    
    # æ—¢å­˜ã‚µãƒ¼ãƒãƒ¼ãƒã‚§ãƒƒã‚¯
    if pgrep -f "vite.*3001" > /dev/null; then
        print_warning "é–‹ç™ºã‚µãƒ¼ãƒãƒ¼ã¯æ—¢ã«ç¨¼åƒä¸­ã§ã™ (Port 3001)"
        return
    fi
    
    # ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ç¢ºèª
    if [ ! -d "node_modules" ]; then
        print_info "ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ä¸­..."
        npm install
    fi
    
    # é–‹ç™ºã‚µãƒ¼ãƒãƒ¼èµ·å‹•
    print_info "Viteé–‹ç™ºã‚µãƒ¼ãƒãƒ¼ã‚’èµ·å‹•ä¸­... (Port 3001)"
    npm run dev &
    
    # èµ·å‹•ç¢ºèª
    sleep 3
    if pgrep -f "vite.*3001" > /dev/null; then
        print_success "é–‹ç™ºã‚µãƒ¼ãƒãƒ¼èµ·å‹•å®Œäº†: http://localhost:3001"
    else
        print_error "é–‹ç™ºã‚µãƒ¼ãƒãƒ¼èµ·å‹•ã«å¤±æ•—ã—ã¾ã—ãŸ"
    fi
}

# ãƒ†ã‚¹ãƒˆwatchå®Ÿè¡Œ
start_test_watch() {
    print_info "ãƒ†ã‚¹ãƒˆwatchã‚’é–‹å§‹ä¸­..."
    
    cd "$PROJECT_ROOT"
    
    # æ—¢å­˜ãƒ†ã‚¹ãƒˆwatchç¢ºèª
    if pgrep -f "npm.*test.*watch" > /dev/null; then
        print_warning "ãƒ†ã‚¹ãƒˆwatchã¯æ—¢ã«å®Ÿè¡Œä¸­ã§ã™"
        return
    fi
    
    # ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
    print_info "Jest ãƒ†ã‚¹ãƒˆwatchãƒ¢ãƒ¼ãƒ‰é–‹å§‹..."
    npm run test:watch &
    
    sleep 2
    if pgrep -f "npm.*test.*watch" > /dev/null; then
        print_success "ãƒ†ã‚¹ãƒˆwatché–‹å§‹å®Œäº†"
    else
        print_error "ãƒ†ã‚¹ãƒˆwatché–‹å§‹ã«å¤±æ•—ã—ã¾ã—ãŸ"
    fi
}

# ESLintè‡ªå‹•ä¿®å¾©
run_eslint_fix() {
    print_info "ESLintè‡ªå‹•ä¿®å¾©ã‚’å®Ÿè¡Œä¸­..."
    
    cd "$PROJECT_ROOT"
    
    # ESLintè¨­å®šç¢ºèª
    if [ ! -f ".eslintrc.js" ] && [ ! -f ".eslintrc.json" ]; then
        print_warning "ESLintè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
        return
    fi
    
    # ä¿®å¾©å‰ã®å•é¡Œæ•°ã‚«ã‚¦ãƒ³ãƒˆ
    local before_issues
    before_issues=$(npx eslint src/ --format=json 2>/dev/null | jq length 2>/dev/null || echo "0")
    
    print_info "ä¿®å¾©å‰ã®Lintå•é¡Œæ•°: $before_issues"
    
    # è‡ªå‹•ä¿®å¾©å®Ÿè¡Œ
    print_info "ESLintè‡ªå‹•ä¿®å¾©å®Ÿè¡Œä¸­..."
    if npx eslint src/ --fix; then
        print_success "ESLintè‡ªå‹•ä¿®å¾©å®Œäº†"
        
        # ä¿®å¾©å¾Œã®å•é¡Œæ•°ãƒã‚§ãƒƒã‚¯
        local after_issues
        after_issues=$(npx eslint src/ --format=json 2>/dev/null | jq length 2>/dev/null || echo "0")
        print_info "ä¿®å¾©å¾Œã®Lintå•é¡Œæ•°: $after_issues"
        
        if [ "$after_issues" -lt "$before_issues" ]; then
            print_success "$((before_issues - after_issues))å€‹ã®å•é¡Œã‚’è‡ªå‹•ä¿®å¾©ã—ã¾ã—ãŸ"
        fi
    else
        print_error "ESLintè‡ªå‹•ä¿®å¾©ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ"
    fi
}

# TypeScriptå‹ãƒã‚§ãƒƒã‚¯
run_type_check() {
    print_info "TypeScriptå‹ãƒã‚§ãƒƒã‚¯ã‚’å®Ÿè¡Œä¸­..."
    
    cd "$PROJECT_ROOT"
    
    if npm run typecheck; then
        print_success "TypeScriptå‹ãƒã‚§ãƒƒã‚¯: åˆæ ¼"
    else
        print_error "TypeScriptå‹ã‚¨ãƒ©ãƒ¼ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ"
        
        # è‡ªå‹•ä¿®å¾©å¯èƒ½ãªå‹ã‚¨ãƒ©ãƒ¼ã®ä¿®å¾©ã‚’è©¦è¡Œ
        print_info "è‡ªå‹•ä¿®å¾©å¯èƒ½ãªå‹ã‚¨ãƒ©ãƒ¼ã‚’ç¢ºèªä¸­..."
        auto_fix_type_errors
    fi
}

# å‹ã‚¨ãƒ©ãƒ¼è‡ªå‹•ä¿®å¾©
auto_fix_type_errors() {
    print_info "å‹ã‚¨ãƒ©ãƒ¼è‡ªå‹•ä¿®å¾©ã‚’è©¦è¡Œä¸­..."
    
    # ã‚ˆãã‚ã‚‹å‹ã‚¨ãƒ©ãƒ¼ãƒ‘ã‚¿ãƒ¼ãƒ³ã®ä¿®å¾©
    local files_to_fix
    files_to_fix=$(find src -name '*.ts' -o -name '*.tsx')
    
    for file in $files_to_fix; do
        # anyå‹ã®æ˜ç¤ºçš„ãªå‹æ³¨é‡ˆè¿½åŠ 
        if grep -q ': any' "$file"; then
            print_info "$file: anyå‹ã‚’ç¢ºèªä¸­..."
        fi
        
        # æœªä½¿ç”¨ã‚¤ãƒ³ãƒãƒ¼ãƒˆã®å‰Šé™¤
        if command -v sed &> /dev/null; then
            # åŸºæœ¬çš„ãªã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ï¼ˆå®‰å…¨ãªæ“ä½œã®ã¿ï¼‰
            sed -i '/^import.*{[^}]*}.*from.*["\'].*["\'];$/s/,\s*}/}/' "$file" 2>/dev/null || true
        fi
    done
    
    print_info "åŸºæœ¬çš„ãªå‹ã‚¨ãƒ©ãƒ¼ä¿®å¾©å®Œäº†"
}

# ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸è¡¨ç¤º
show_test_coverage() {
    print_info "ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸ã‚’ç”Ÿæˆä¸­..."
    
    cd "$PROJECT_ROOT"
    
    if npm run test:coverage; then
        print_success "ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸ç”Ÿæˆå®Œäº†"
        
        if [ -f "coverage/lcov-report/index.html" ]; then
            print_success "ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ¬ãƒãƒ¼ãƒˆ: coverage/lcov-report/index.html"
        fi
        
        # ã‚«ãƒãƒ¬ãƒƒã‚¸ã‚µãƒãƒªãƒ¼è¡¨ç¤º
        if [ -f "coverage/coverage-summary.json" ]; then
            print_info "ã‚«ãƒãƒ¬ãƒƒã‚¸ã‚µãƒãƒªãƒ¼:"
            if command -v jq &> /dev/null; then
                jq '.total' coverage/coverage-summary.json 2>/dev/null || echo "è©³ç´°ã¯coverage/ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ç¢ºèªã—ã¦ãã ã•ã„"
            fi
        fi
    else
        print_error "ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ"
    fi
}

# ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆè‡ªå‹•ä¿®å¾©
fix_components_auto() {
    print_info "ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆè‡ªå‹•ä¿®å¾©ã‚’å®Ÿè¡Œä¸­..."
    
    cd "$PROJECT_ROOT"
    
    local components_dir="src/components"
    local pages_dir="src/pages"
    
    # ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ç¢ºèª
    if [ -d "$components_dir" ]; then
        print_info "ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªç¢ºèªå®Œäº†"
        
        # React import ã®çµ±ä¸€
        find "$components_dir" "$pages_dir" -name '*.tsx' -type f | while read -r file; do
            # React 18+ ã® import å½¢å¼ã«çµ±ä¸€
            if ! grep -q "import React" "$file"; then
                if grep -q "useState\|useEffect\|useContext" "$file"; then
                    print_info "React importè¿½åŠ : $(basename "$file")"
                    sed -i '1i import React from "react";' "$file" 2>/dev/null || true
                fi
            fi
            
            # æœªä½¿ç”¨ã®console.logå‰Šé™¤
            if grep -q "console.log" "$file"; then
                print_warning "console.logæ¤œå‡º: $(basename "$file")"
                # æœ¬ç•ªç’°å¢ƒã§ã¯å‰Šé™¤ï¼ˆé–‹ç™ºä¸­ã¯æ®‹ã™ï¼‰
            fi
        done
        
        print_success "ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆåŸºæœ¬ä¿®å¾©å®Œäº†"
    fi
}

# UIå‹•ä½œç¢ºèª
check_ui_functionality() {
    print_info "UIå‹•ä½œç¢ºèªã‚’å®Ÿè¡Œä¸­..."
    
    cd "$PROJECT_ROOT"
    
    # é–‹ç™ºã‚µãƒ¼ãƒãƒ¼çŠ¶æ³ç¢ºèª
    if pgrep -f "vite.*3001" > /dev/null; then
        print_success "é–‹ç™ºã‚µãƒ¼ãƒãƒ¼: ç¨¼åƒä¸­ (http://localhost:3001)"
        
        # åŸºæœ¬çš„ãªã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆãƒã‚§ãƒƒã‚¯
        if command -v curl &> /dev/null; then
            if curl -s http://localhost:3001 > /dev/null; then
                print_success "ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰: ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½"
            else
                print_warning "ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰: ã‚¢ã‚¯ã‚»ã‚¹ä¸å¯"
            fi
        fi
    else
        print_warning "é–‹ç™ºã‚µãƒ¼ãƒãƒ¼ãŒèµ·å‹•ã—ã¦ã„ã¾ã›ã‚“"
        print_info "èµ·å‹•ã—ã¾ã™ã‹ï¼Ÿ (y/n)"
        read -r response
        if [[ "$response" =~ ^[Yy]$ ]]; then
            start_dev_server
        fi
    fi
    
    # ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰APIç¢ºèª
    if command -v curl &> /dev/null; then
        if curl -s http://localhost:8082/api/health > /dev/null 2>&1; then
            print_success "ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰API: å¿œç­”ã‚ã‚Š"
        else
            print_warning "ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰API: å¿œç­”ãªã— (Port 8082)"
        fi
    fi
    
    # é‡è¦ãªãƒšãƒ¼ã‚¸ã®ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
    print_info "é‡è¦ãƒšãƒ¼ã‚¸ã®ãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¸­..."
    if [ -f "src/pages/LoginPage.tsx" ]; then
        npm test -- --testPathPattern="LoginPage" --watchAll=false 2>/dev/null && print_success "LoginPage: ãƒ†ã‚¹ãƒˆåˆæ ¼" || print_warning "LoginPage: ãƒ†ã‚¹ãƒˆè¦ç¢ºèª"
    fi
    
    if [ -f "src/pages/DashboardPage.tsx" ]; then
        npm test -- --testPathPattern="DashboardPage" --watchAll=false 2>/dev/null && print_success "DashboardPage: ãƒ†ã‚¹ãƒˆåˆæ ¼" || print_warning "DashboardPage: ãƒ†ã‚¹ãƒˆè¦ç¢ºèª"
    fi
}

# ä¾å­˜é–¢ä¿‚æ›´æ–°
update_dependencies() {
    print_info "ä¾å­˜é–¢ä¿‚ã®æ›´æ–°ãƒã‚§ãƒƒã‚¯ä¸­..."
    
    cd "$PROJECT_ROOT"
    
    # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç›£æŸ»
    print_info "ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç›£æŸ»å®Ÿè¡Œä¸­..."
    if npm audit; then
        print_success "ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç›£æŸ»: å•é¡Œãªã—"
    else
        print_warning "ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è„†å¼±æ€§ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ"
        print_info "è‡ªå‹•ä¿®å¾©ã‚’å®Ÿè¡Œã—ã¾ã™ã‹ï¼Ÿ (y/n)"
        read -r response
        if [[ "$response" =~ ^[Yy]$ ]]; then
            npm audit fix
        fi
    fi
    
    # ä¾å­˜é–¢ä¿‚æ›´æ–°ç¢ºèª
    if command -v npm-check-updates &> /dev/null; then
        print_info "åˆ©ç”¨å¯èƒ½ãªæ›´æ–°ç¢ºèªä¸­..."
        ncu
    else
        print_info "npm-check-updatesæœªã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«"
        print_info "ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã‹ï¼Ÿ (y/n)"
        read -r response
        if [[ "$response" =~ ^[Yy]$ ]]; then
            npm install -g npm-check-updates
        fi
    fi
}

# ãƒ†ã‚¹ãƒˆè‡ªå‹•ç”Ÿæˆ
generate_tests_auto() {
    print_info "ãƒ†ã‚¹ãƒˆè‡ªå‹•ç”Ÿæˆã‚’å®Ÿè¡Œä¸­..."
    
    cd "$PROJECT_ROOT"
    
    # ãƒ†ã‚¹ãƒˆãŒå­˜åœ¨ã—ãªã„ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆæ¤œå‡º
    local components_without_tests=()
    
    find src/components -name '*.tsx' -type f | while read -r component; do
        local component_name
        component_name=$(basename "$component" .tsx)
        local test_file="src/components/__tests__/${component_name}.test.tsx"
        
        if [ ! -f "$test_file" ]; then
            print_info "ãƒ†ã‚¹ãƒˆãŒä¸è¶³: $component_name"
            
            # åŸºæœ¬çš„ãªãƒ†ã‚¹ãƒˆãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆç”Ÿæˆ
            mkdir -p "src/components/__tests__"
            cat > "$test_file" << EOF
import React from 'react';
import { render, screen } from '@testing-library/react';
import { ${component_name} } from '../${component_name}';

describe('${component_name}', () => {
  it('renders without crashing', () => {
    render(<${component_name} />);
  });
  
  it('displays expected content', () => {
    render(<${component_name} />);
    // Add specific test assertions here
  });
});
EOF
            print_success "ãƒ†ã‚¹ãƒˆç”Ÿæˆå®Œäº†: $test_file"
        fi
    done
    
    # ãƒšãƒ¼ã‚¸ãƒ†ã‚¹ãƒˆè‡ªå‹•ç”Ÿæˆ
    find src/pages -name '*.tsx' -type f | while read -r page; do
        local page_name
        page_name=$(basename "$page" .tsx)
        local test_file="src/pages/__tests__/${page_name}.test.tsx"
        
        if [ ! -f "$test_file" ] && [ "$page_name" != "index" ]; then
            print_info "ãƒšãƒ¼ã‚¸ãƒ†ã‚¹ãƒˆãŒä¸è¶³: $page_name"
            
            mkdir -p "src/pages/__tests__"
            cat > "$test_file" << EOF
import React from 'react';
import { render, screen } from '@testing-library/react';
import { BrowserRouter } from 'react-router-dom';
import { ${page_name} } from '../${page_name}';

const renderWithRouter = (component: React.ReactElement) => {
  return render(
    <BrowserRouter>
      {component}
    </BrowserRouter>
  );
};

describe('${page_name}', () => {
  it('renders without crashing', () => {
    renderWithRouter(<${page_name} />);
  });
  
  it('displays page title or header', () => {
    renderWithRouter(<${page_name} />);
    // Add specific test assertions here
  });
});
EOF
            print_success "ãƒšãƒ¼ã‚¸ãƒ†ã‚¹ãƒˆç”Ÿæˆå®Œäº†: $test_file"
        fi
    done
}

# å…¨è‡ªå‹•ä¿®å¾©ãƒ¢ãƒ¼ãƒ‰
run_full_auto_fix() {
    print_info "å…¨è‡ªå‹•ä¿®å¾©ãƒ¢ãƒ¼ãƒ‰ã‚’é–‹å§‹ã—ã¾ã™..."
    
    echo ""
    print_info "ğŸ”„ Step 1: ESLintè‡ªå‹•ä¿®å¾©"
    run_eslint_fix
    
    echo ""
    print_info "ğŸ”„ Step 2: TypeScriptå‹ãƒã‚§ãƒƒã‚¯"
    run_type_check
    
    echo ""
    print_info "ğŸ”„ Step 3: ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆä¿®å¾©"
    fix_components_auto
    
    echo ""
    print_info "ğŸ”„ Step 4: ãƒ†ã‚¹ãƒˆè‡ªå‹•ç”Ÿæˆ"
    generate_tests_auto
    
    echo ""
    print_info "ğŸ”„ Step 5: ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ"
    npm test -- --watchAll=false
    
    echo ""
    print_info "ğŸ”„ Step 6: é–‹ç™ºã‚µãƒ¼ãƒãƒ¼ç¢ºèª"
    if ! pgrep -f "vite.*3001" > /dev/null; then
        start_dev_server
    fi
    
    echo ""
    print_success "å…¨è‡ªå‹•ä¿®å¾©ãƒ¢ãƒ¼ãƒ‰å®Œäº†"
    print_info "ç¶™ç¶šç›£è¦–ã‚’é–‹å§‹ã—ã¾ã™ã‹ï¼Ÿ (y/n)"
    read -r response
    if [[ "$response" =~ ^[Yy]$ ]]; then
        continuous_monitoring
    fi
}

# ç¶™ç¶šç›£è¦–ãƒ¢ãƒ¼ãƒ‰
continuous_monitoring() {
    print_info "ç¶™ç¶šç›£è¦–ãƒ¢ãƒ¼ãƒ‰ã‚’é–‹å§‹ã—ã¾ã™..."
    print_info "åœæ­¢ã™ã‚‹ã«ã¯ Ctrl+C ã‚’æŠ¼ã—ã¦ãã ã•ã„"
    
    while true; do
        sleep 30
        
        # ãƒ•ã‚¡ã‚¤ãƒ«å¤‰æ›´ç›£è¦–ï¼ˆç°¡æ˜“ç‰ˆï¼‰
        local changed_files
        changed_files=$(find src -name '*.ts' -o -name '*.tsx' -newer /tmp/last_check 2>/dev/null | wc -l)
        
        if [ "$changed_files" -gt 0 ]; then
            print_info "ãƒ•ã‚¡ã‚¤ãƒ«å¤‰æ›´ã‚’æ¤œå‡ºã—ã¾ã—ãŸ ($changed_files ãƒ•ã‚¡ã‚¤ãƒ«)"
            
            # è‡ªå‹•ãƒã‚§ãƒƒã‚¯å®Ÿè¡Œ
            npm run typecheck &> /dev/null && print_success "å‹ãƒã‚§ãƒƒã‚¯: OK" || print_warning "å‹ãƒã‚§ãƒƒã‚¯: ã‚¨ãƒ©ãƒ¼æ¤œå‡º"
            npx eslint src/ &> /dev/null && print_success "ESLint: OK" || print_warning "ESLint: ã‚¨ãƒ©ãƒ¼æ¤œå‡º"
            
            # å®šæœŸçš„ã«WorktreeåŒæœŸï¼ˆ5åˆ†é–“éš”ï¼‰
            local current_time=$(date +%s)
            local last_sync_time=$(stat -c %Y /tmp/last_ui_sync 2>/dev/null || echo "0")
            local time_diff=$((current_time - last_sync_time))
            
            if [ $time_diff -gt 300 ]; then  # 5åˆ†çµŒé
                print_info "å®šæœŸWorktreeåŒæœŸã‚’å®Ÿè¡Œä¸­..."
                auto_sync_worktree
                touch /tmp/last_ui_sync
            fi
        fi
        
        touch /tmp/last_check
    done
}

# ãƒ¡ã‚¤ãƒ³ãƒ«ãƒ¼ãƒ—
main_loop() {
    print_header
    
    # UI/ãƒ†ã‚¹ãƒˆç”¨WorktreeåˆæœŸåŒ–
    init_ui_worktree
    
    while true; do
        show_ui_menu
        echo -n "é¸æŠã—ã¦ãã ã•ã„: "
        read -r choice
        
        case $choice in
            1)
                start_dev_server
                ;;
            2)
                start_test_watch
                ;;
            3)
                run_eslint_fix
                ;;
            4)
                run_type_check
                ;;
            5)
                show_test_coverage
                ;;
            6)
                fix_components_auto
                ;;
            7)
                check_ui_functionality
                ;;
            8)
                update_dependencies
                ;;
            9)
                generate_tests_auto
                ;;
            a|A)
                run_full_auto_fix
                ;;
            0)
                clear
                print_header
                ;;
            q|Q)
                print_info "UI/ãƒ†ã‚¹ãƒˆè‡ªå‹•ä¿®å¾©ã‚’çµ‚äº†ã—ã¾ã™"
                exit 0
                ;;
            *)
                print_warning "ç„¡åŠ¹ãªé¸æŠã§ã™ã€‚å†åº¦é¸æŠã—ã¦ãã ã•ã„ã€‚"
                ;;
        esac
        
        echo ""
        echo "Press Enter to continue..."
        read -r
    done
}

# ã‚¹ã‚¯ãƒªãƒ—ãƒˆé–‹å§‹
main_loop