# ServiceGrid データベース仕様書

## 1. データベース概要

### 1.1 基本情報
- **データベース種別**: SQLite
- **ファイル場所**: `/backend/db/itsm.sqlite`
- **文字エンコーディング**: UTF-8
- **照合順序**: NOCASE (大文字小文字区別なし)
- **外部キー制約**: 有効

### 1.2 設計方針
- **ITIL準拠**: ITILフレームワークに基づくテーブル設計
- **正規化**: 第3正規形まで正規化
- **拡張性**: 新規機能追加に対応した柔軟な設計
- **パフォーマンス**: 適切なインデックス設計
- **監査証跡**: 全操作の記録機能

## 2. テーブル一覧

### 2.1 基本管理テーブル
| テーブル名 | 説明 | 主要機能 |
|-----------|------|---------|
| users | ユーザー管理 | 認証・認可・ロール管理 |
| logs | 監査ログ | 全操作の記録・追跡 |

### 2.2 ITSMコアテーブル
| テーブル名 | 説明 | 主要機能 |
|-----------|------|---------|
| incidents | インシデント管理 | 障害・問題の記録・追跡 |
| service_requests | サービスリクエスト | ユーザー申請・要求管理 |
| changes | 変更管理 | 設定変更の計画・承認 |
| releases | リリース管理 | システム展開・リリース |
| problems | 問題管理 | 根本原因分析・再発防止 |
| knowledge | ナレッジ管理 | 情報・手順書の蓄積 |

### 2.3 資産管理テーブル
| テーブル名 | 説明 | 主要機能 |
|-----------|------|---------|
| assets | 資産マスタ | IT資産の包括的管理 |

### 2.4 運用管理テーブル
| テーブル名 | 説明 | 主要機能 |
|-----------|------|---------|
| slas | SLA管理 | サービスレベル目標・実績 |
| capacity | キャパシティ管理 | リソース使用率・計画 |
| availability | 可用性管理 | システム稼働率・監視 |

## 3. 詳細テーブル仕様

### 3.1 ユーザー管理テーブル (users)

```sql
CREATE TABLE users (
    user_id INTEGER PRIMARY KEY AUTOINCREMENT,
    username TEXT UNIQUE NOT NULL,
    password_hash TEXT NOT NULL,
    password_salt TEXT NOT NULL,
    role TEXT NOT NULL DEFAULT 'user',
    display_name TEXT,
    email TEXT,
    last_login DATETIME,
    failed_login_attempts INTEGER DEFAULT 0,
    account_locked BOOLEAN DEFAULT FALSE,
    account_locked_until DATETIME,
    password_reset_token TEXT,
    password_reset_expires DATETIME,
    created_date DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_date DATETIME DEFAULT CURRENT_TIMESTAMP,
    
    CONSTRAINT users_role_check CHECK (role IN ('administrator', 'operator', 'user', 'readonly')),
    CONSTRAINT users_email_check CHECK (email LIKE '%@%')
);
```

**フィールド説明:**
| フィールド名 | 型 | 制約 | 説明 |
|-------------|---|------|------|
| user_id | INTEGER | PK, AUTO | ユーザーID |
| username | TEXT | UNIQUE, NOT NULL | ログインユーザー名 |
| password_hash | TEXT | NOT NULL | パスワードハッシュ (bcrypt) |
| password_salt | TEXT | NOT NULL | パスワードソルト |
| role | TEXT | CHECK | ユーザーロール (administrator/operator/user/readonly) |
| display_name | TEXT | - | 表示名 |
| email | TEXT | CHECK | メールアドレス |
| last_login | DATETIME | - | 最終ログイン日時 |
| failed_login_attempts | INTEGER | DEFAULT 0 | 連続ログイン失敗回数 |
| account_locked | BOOLEAN | DEFAULT FALSE | アカウントロック状態 |
| account_locked_until | DATETIME | - | ロック解除日時 |

### 3.2 インシデント管理テーブル (incidents)

```sql
CREATE TABLE incidents (
    incident_id INTEGER PRIMARY KEY AUTOINCREMENT,
    title TEXT NOT NULL,
    description TEXT NOT NULL,
    reported_by TEXT NOT NULL,
    assigned_to TEXT,
    status TEXT NOT NULL DEFAULT 'Open' CHECK (status IN ('Open', 'In Progress', 'Resolved', 'Closed', 'Pending')),
    priority TEXT NOT NULL DEFAULT 'Medium' CHECK (priority IN ('Low', 'Medium', 'High', 'Critical')),
    category TEXT DEFAULT 'General',
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    resolved_at DATETIME,
    closed_at DATETIME,
    impact TEXT CHECK (impact IN ('Low', 'Medium', 'High')),
    urgency TEXT CHECK (urgency IN ('Low', 'Medium', 'High')),
    resolution TEXT,
    workaround TEXT,
    related_assets TEXT, -- JSON形式
    tags TEXT -- JSON形式
);
```

**フィールド説明:**
| フィールド名 | 型 | 制約 | 説明 |
|-------------|---|------|------|
| incident_id | INTEGER | PK, AUTO | インシデントID |
| title | TEXT | NOT NULL | インシデントタイトル |
| description | TEXT | NOT NULL | 詳細説明 |
| reported_by | TEXT | NOT NULL | 報告者 |
| assigned_to | TEXT | - | 担当者 |
| status | TEXT | CHECK | ステータス (Open/In Progress/Resolved/Closed/Pending) |
| priority | TEXT | CHECK | 優先度 (Low/Medium/High/Critical) |
| category | TEXT | DEFAULT 'General' | カテゴリ |
| impact | TEXT | CHECK | 影響度 (Low/Medium/High) |
| urgency | TEXT | CHECK | 緊急度 (Low/Medium/High) |
| resolution | TEXT | - | 解決内容 |
| workaround | TEXT | - | 回避策 |
| related_assets | TEXT | JSON | 関連資産 (JSON配列) |
| tags | TEXT | JSON | タグ (JSON配列) |

**サンプルデータ:**
```sql
INSERT INTO incidents (
    title, description, reported_by, assigned_to, status, priority, category
) VALUES 
    ('Webサーバーダウン', 'メインWebサーバー（srv-web-01）が応答しません。', 'user01', 'admin', 'Open', 'Critical', 'Infrastructure'),
    ('メール送信不具合', 'ユーザーからメールが送信できないとの報告があります。', 'user02', 'operator', 'In Progress', 'High', 'Email');
```

### 3.3 資産管理テーブル (assets)

```sql
CREATE TABLE assets (
  asset_id INTEGER PRIMARY KEY AUTOINCREMENT,
  asset_tag VARCHAR(50) UNIQUE NOT NULL,
  name VARCHAR(200) NOT NULL,
  description TEXT,
  category VARCHAR(100) NOT NULL DEFAULT 'Hardware',
  type VARCHAR(100),
  manufacturer VARCHAR(100),
  model VARCHAR(100),
  serial_number VARCHAR(100),
  location VARCHAR(200),
  department VARCHAR(100),
  owner VARCHAR(100),
  assigned_to VARCHAR(100),
  status VARCHAR(50) NOT NULL DEFAULT 'Active',
  purchase_date DATE,
  purchase_cost DECIMAL(12,2),
  warranty_expiry DATE,
  last_maintenance DATE,
  next_maintenance DATE,
  ip_address VARCHAR(45),
  mac_address VARCHAR(17),
  operating_system VARCHAR(100),
  software_licenses TEXT, -- JSON配列
  configuration TEXT, -- JSONオブジェクト
  notes TEXT,
  tags TEXT, -- JSON配列
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  created_by VARCHAR(100),
  updated_by VARCHAR(100)
);
```

**フィールド説明:**
| フィールド名 | 型 | 制約 | 説明 |
|-------------|---|------|------|
| asset_id | INTEGER | PK, AUTO | 資産ID |
| asset_tag | VARCHAR(50) | UNIQUE, NOT NULL | 資産タグ (一意識別子) |
| name | VARCHAR(200) | NOT NULL | 資産名 |
| description | TEXT | - | 詳細説明 |
| category | VARCHAR(100) | DEFAULT 'Hardware' | カテゴリ |
| type | VARCHAR(100) | - | 種別 |
| manufacturer | VARCHAR(100) | - | 製造元 |
| model | VARCHAR(100) | - | モデル |
| serial_number | VARCHAR(100) | - | シリアル番号 |
| location | VARCHAR(200) | - | 設置場所 |
| department | VARCHAR(100) | - | 部門 |
| owner | VARCHAR(100) | - | 所有者 |
| assigned_to | VARCHAR(100) | - | 使用者 |
| status | VARCHAR(50) | CHECK | ステータス (Active/Inactive/Maintenance/Retired等) |
| purchase_date | DATE | - | 購入日 |
| purchase_cost | DECIMAL(12,2) | - | 購入費用 |
| warranty_expiry | DATE | - | 保証期限 |
| ip_address | VARCHAR(45) | - | IPアドレス (IPv4/IPv6対応) |
| mac_address | VARCHAR(17) | - | MACアドレス |
| operating_system | VARCHAR(100) | - | OS |
| software_licenses | TEXT | JSON | ソフトウェアライセンス |
| configuration | TEXT | JSON | 構成情報 |
| tags | TEXT | JSON | タグ |

**ステータス値:**
- Active: 稼働中
- Inactive: 停止中  
- Maintenance: メンテナンス中
- Retired: 廃棄済み
- Lost: 紛失
- Stolen: 盗難
- Disposed: 処分済み

### 3.4 サービスリクエストテーブル (service_requests)

```sql
CREATE TABLE service_requests (
    request_id INTEGER PRIMARY KEY AUTOINCREMENT,
    subject TEXT,
    detail TEXT,
    status TEXT,
    applicant TEXT,
    requested_date DATE,
    approved_by TEXT,
    approved_date DATE,
    created_date DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_date DATETIME DEFAULT CURRENT_TIMESTAMP
);
```

### 3.5 変更管理テーブル (changes)

```sql
CREATE TABLE changes (
    change_id INTEGER PRIMARY KEY AUTOINCREMENT,
    subject TEXT,
    detail TEXT,
    status TEXT,
    requested_by TEXT,
    approved_by TEXT,
    request_date DATE,
    approve_date DATE,
    created_date DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_date DATETIME DEFAULT CURRENT_TIMESTAMP
);
```

### 3.6 その他のITSMテーブル

#### 3.6.1 リリース管理 (releases)
```sql
CREATE TABLE releases (
    release_id INTEGER PRIMARY KEY AUTOINCREMENT,
    title TEXT,
    description TEXT,
    status TEXT,
    release_date DATE,
    responsible TEXT,
    created_date DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_date DATETIME DEFAULT CURRENT_TIMESTAMP
);
```

#### 3.6.2 問題管理 (problems)
```sql
CREATE TABLE problems (
    problem_id INTEGER PRIMARY KEY AUTOINCREMENT,
    title TEXT,
    root_cause TEXT,
    status TEXT,
    registered_date DATE,
    closed_date DATE,
    created_date DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_date DATETIME DEFAULT CURRENT_TIMESTAMP
);
```

#### 3.6.3 ナレッジ管理 (knowledge)
```sql
CREATE TABLE knowledge (
    knowledge_id INTEGER PRIMARY KEY AUTOINCREMENT,
    title TEXT,
    content TEXT,
    category TEXT,
    created_by TEXT,
    created_date DATE,
    updated_date DATETIME DEFAULT CURRENT_TIMESTAMP
);
```

### 3.7 運用管理テーブル

#### 3.7.1 SLA管理 (slas)
```sql
CREATE TABLE slas (
    sla_id INTEGER PRIMARY KEY AUTOINCREMENT,
    service_name TEXT,
    target_value REAL,
    actual_value REAL,
    measurement_date DATE,
    status TEXT,
    created_date DATETIME DEFAULT CURRENT_TIMESTAMP
);
```

#### 3.7.2 キャパシティ管理 (capacity)
```sql
CREATE TABLE capacity (
    capacity_id INTEGER PRIMARY KEY AUTOINCREMENT,
    resource_name TEXT,
    current_usage REAL,
    max_capacity REAL,
    threshold_percent REAL,
    measurement_date DATE,
    created_date DATETIME DEFAULT CURRENT_TIMESTAMP
);
```

#### 3.7.3 可用性管理 (availability)
```sql
CREATE TABLE availability (
    availability_id INTEGER PRIMARY KEY AUTOINCREMENT,
    service_name TEXT,
    uptime_percent REAL,
    downtime_minutes INTEGER,
    measurement_date DATE,
    created_date DATETIME DEFAULT CURRENT_TIMESTAMP
);
```

### 3.8 監査ログテーブル (logs)

```sql
CREATE TABLE logs (
    log_id INTEGER PRIMARY KEY AUTOINCREMENT,
    event_type TEXT,
    event_time DATETIME,
    user TEXT,
    detail TEXT
);
```

## 4. インデックス仕様

### 4.1 ユーザー管理インデックス
```sql
CREATE INDEX idx_users_username ON users(username);
CREATE INDEX idx_users_email ON users(email);
```

### 4.2 インシデント管理インデックス
```sql
CREATE INDEX idx_incidents_status ON incidents(status);
CREATE INDEX idx_incidents_priority ON incidents(priority);
CREATE INDEX idx_incidents_assigned_to ON incidents(assigned_to);
CREATE INDEX idx_incidents_created_at ON incidents(created_at);
CREATE INDEX idx_incidents_category ON incidents(category);
```

### 4.3 資産管理インデックス
```sql
CREATE INDEX idx_assets_tag ON assets(asset_tag);
CREATE INDEX idx_assets_category ON assets(category);
CREATE INDEX idx_assets_status ON assets(status);
CREATE INDEX idx_assets_location ON assets(location);
CREATE INDEX idx_assets_assigned_to ON assets(assigned_to);
CREATE INDEX idx_assets_created_at ON assets(created_at);
```

### 4.4 その他インデックス
```sql
CREATE INDEX idx_service_requests_status ON service_requests(status);
CREATE INDEX idx_logs_event_time ON logs(event_time);
CREATE INDEX idx_logs_user ON logs(user);
```

## 5. トリガー仕様

### 5.1 更新日時自動更新トリガー

#### インシデント更新トリガー
```sql
CREATE TRIGGER update_incidents_timestamp 
    AFTER UPDATE ON incidents
    FOR EACH ROW
BEGIN
    UPDATE incidents SET updated_at = CURRENT_TIMESTAMP WHERE incident_id = NEW.incident_id;
END;
```

#### 資産更新トリガー
```sql
CREATE TRIGGER update_assets_timestamp 
  AFTER UPDATE ON assets
  BEGIN
    UPDATE assets SET updated_at = CURRENT_TIMESTAMP WHERE asset_id = NEW.asset_id;
  END;
```

### 5.2 データバリデーショントリガー

#### 資産ステータス検証トリガー
```sql
CREATE TRIGGER validate_asset_status
  BEFORE INSERT ON assets
  BEGIN
    SELECT CASE
      WHEN NEW.status NOT IN ('Active', 'Inactive', 'Maintenance', 'Retired', 'Lost', 'Stolen', 'Disposed')
      THEN RAISE(ABORT, 'Invalid asset status')
    END;
  END;
```

## 6. ビュー仕様

### 6.1 資産統計ビュー
```sql
CREATE VIEW asset_stats AS
SELECT 
  category,
  status,
  COUNT(*) as count,
  AVG(purchase_cost) as avg_cost,
  SUM(purchase_cost) as total_cost
FROM assets 
GROUP BY category, status;
```

### 6.2 保証期限ビュー
```sql
CREATE VIEW warranty_expiring AS
SELECT 
  asset_id,
  asset_tag,
  name,
  warranty_expiry,
  CASE 
    WHEN warranty_expiry < date('now') THEN 'Expired'
    WHEN warranty_expiry < date('now', '+30 days') THEN 'Expiring Soon'
    ELSE 'Valid'
  END as warranty_status
FROM assets 
WHERE warranty_expiry IS NOT NULL
ORDER BY warranty_expiry ASC;
```

### 6.3 メンテナンス予定ビュー
```sql
CREATE VIEW maintenance_schedule AS
SELECT 
  asset_id,
  asset_tag,
  name,
  last_maintenance,
  next_maintenance,
  CASE 
    WHEN next_maintenance < date('now') THEN 'Overdue'
    WHEN next_maintenance < date('now', '+7 days') THEN 'Due Soon'
    ELSE 'Scheduled'
  END as maintenance_status
FROM assets 
WHERE next_maintenance IS NOT NULL
ORDER BY next_maintenance ASC;
```

## 7. 初期データ

### 7.1 デフォルトユーザー
```sql
INSERT INTO users (username, password_hash, password_salt, role, display_name, email) 
VALUES 
('admin', 'ハッシュ化パスワード', 'ソルト', 'administrator', '管理者', 'admin@company.com'),
('operator', 'ハッシュ化パスワード', 'ソルト', 'operator', 'オペレータ', 'operator@company.com');
```

### 7.2 サンプル資産データ
- Webサーバー (SRV-001)
- 開発用ワークステーション (WS-001)  
- ネットワークスイッチ (NW-001)
- ノートPC (LAP-001)
- プリンター (PR-001)
- データベースサーバー (DB-001)
- モニター (MON-001)
- ファイアウォール (FIRE-001)

## 8. データベース運用

### 8.1 バックアップ戦略
- **自動バックアップ**: 日次自動バックアップ
- **保存期間**: 30日間
- **バックアップ場所**: `/backend/backup/` ディレクトリ

### 8.2 メンテナンス
- **VACUUM**: 月次実行（データベース最適化）
- **ANALYZE**: 週次実行（統計情報更新）
- **ログローテーション**: 監査ログの定期圧縮・アーカイブ

### 8.3 モニタリング
- **データベースサイズ**: 定期監視
- **クエリパフォーマンス**: スロークエリ監視
- **接続数**: 同時接続数監視

この仕様に基づき、ITILに準拠した包括的なITSMデータベースシステムが構築されています。